<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MyScoreBuy - Tienda de Partituras</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- PDF.js para mostrar vistas previas de PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
<!-- JSZip para procesar archivos MXL -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
  /* Estilos optimizados y mejorados */
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    background: #faf7ff; 
    margin:0; 
    min-height: 100vh;
  }
  .card { 
    transition: all 0.3s ease; 
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
  }
  .card:hover { 
    transform: translateY(-5px); 
    box-shadow: 0 10px 20px rgba(124, 58, 237, 0.15);
    cursor:pointer; 
  }
  .header { 
    position: fixed; 
    top:0; 
    left:0; 
    right:0; 
    z-index:50;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  main { 
    padding-top: 140px; /* Aumentado para evitar superposición */
    padding-bottom: 40px;
  } 
  #cartBtn {
    position: fixed; 
    bottom: 20px; 
    right: 20px;
    width: 60px; 
    height: 60px; 
    border-radius: 50%;
    background: #7c3aed; 
    color: white; 
    display:flex;
    justify-content:center; 
    align-items:center; 
    font-size:1.5rem;
    box-shadow:0 4px 10px rgba(0,0,0,0.3); 
    cursor:pointer; 
    z-index:50;
    transition: all 0.3s ease;
  }
  #cartBtn:hover { 
    transform: scale(1.1); 
    background: #6d28d9;
  }
  #cartContainer {
    position: fixed; 
    bottom: 90px; 
    right: 20px;
    background:white; 
    border-radius:12px; 
    box-shadow:0 10px 25px rgba(0,0,0,0.2); 
    width: 320px; 
    max-height: 400px; 
    overflow-y:auto; 
    padding:20px; 
    display:none; 
    z-index:50;
  }
  .hidden { 
    display:none; 
  }
  .no-orders-msg {
    display: flex; 
    justify-content:center; 
    align-items:center;
    font-size:1.2rem; 
    font-weight:bold; 
    color:white;
    background: rgba(107, 33, 168, 0.8);
    border-radius: 12px; 
    padding: 40px; 
    text-align:center; 
    height:100%;
  }
  
  /* ========== NUEVO MODAL DE AUTENTICACIÓN ========== */
  #authModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  
  .auth-box {
    position: relative;
    width: 90%;
    max-width: 420px;
    background: #2d2d39;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 15px 50px rgba(0,0,0,0.5);
    overflow: hidden;
  }
  
  .auth-box::before {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: conic-gradient(
      from 0deg,
      #7c3aed,
      #6d28d9,
      #8b5cf6,
      #a78bfa,
      #7c3aed
    );
    animation: rotating 4s linear infinite;
    z-index: -1;
  }
  
  .auth-box::after {
    content: "";
    position: absolute;
    inset: 4px;
    background: #2d2d39;
    border-radius: 16px;
    z-index: -1;
  }
  
  @keyframes rotating {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  
  .auth-content {
    position: relative;
    z-index: 10;
    color: white;
  }
  
  .auth-tabs {
    display: flex;
    margin-bottom: 25px;
    border-bottom: 2px solid #4c4c5c;
  }
  
  .auth-tab {
    flex: 1;
    text-align: center;
    padding: 12px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    border-bottom: 3px solid transparent;
  }
  
  .auth-tab.active {
    color: #a78bfa;
    border-bottom-color: #7c3aed;
  }
  
  .auth-form {
    display: none;
  }
  
  .auth-form.active {
    display: block;
    animation: fadeIn 0.5s ease;
  }
  
  .auth-form h3 {
    text-align: center;
    margin-bottom: 20px;
    font-size: 1.5rem;
    color: #a78bfa;
  }
  
  .auth-form-group {
    margin-bottom: 20px;
  }
  
  .auth-form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #d1d5db;
  }
  
  .auth-form-group input {
    width: 100%;
    padding: 12px 15px;
    border-radius: 8px;
    border: 2px solid #4c4c5c;
    background: #3a3a4a;
    color: white;
    font-size: 16px;
    transition: all 0.3s;
  }
  
  .auth-form-group input:focus {
    outline: none;
    border-color: #7c3aed;
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
  }
  
  .auth-btn {
    width: 100%;
    padding: 14px;
    border-radius: 8px;
    background: #7c3aed;
    color: white;
    font-weight: 600;
    font-size: 16px;
    border: none;
    cursor: pointer;
    transition: all 0.3s;
    margin-top: 10px;
  }
  
  .auth-btn:hover {
    background: #6d28d9;
    transform: translateY(-2px);
  }
  
  .auth-btn:disabled {
    background: #4c4c5c;
    cursor: not-allowed;
    transform: none;
  }
  
  .auth-footer {
    text-align: center;
    margin-top: 20px;
    font-size: 14px;
    color: #9ca3af;
  }
  
  .auth-footer a {
    color: #a78bfa;
    text-decoration: none;
    cursor: pointer;
  }
  
  .auth-footer a:hover {
    text-decoration: underline;
  }
  
  .close-auth {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    color: #ef4444;
    font-size: 1.5rem;
    cursor: pointer;
    z-index: 20;
  }
  
  .auth-error {
    color: #ef4444;
    font-size: 14px;
    margin-top: 5px;
    display: none;
  }
  
  .auth-success {
    color: #10b981;
    font-size: 14px;
    margin-top: 5px;
    display: none;
  }
  
  /* Resto de estilos existentes... */
  /* Modal de Perfil */
  #profileModal {
    display:none; 
    position:fixed; 
    top:0; 
    left:0; 
    width:100%; 
    height:100%;
    background: rgba(0,0,0,0.5); 
    justify-content:center; 
    align-items:center; 
    z-index:60;
  }
  #profileContent {
    background:white; 
    border-radius:16px; 
    padding:25px; 
    width:90%; 
    max-width:400px; 
    position:relative;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }
  #profileContent button.closeProfile {
    position:absolute; 
    top:15px; 
    right:15px; 
    font-size:1.5rem; 
    font-weight:bold; 
    color:#ef4444;
    background: none;
    border: none;
    cursor: pointer;
  }
  /* Modal de Partitura */
  #scoreModal {
    display:none; 
    position:fixed; 
    top:0; 
    left:0; 
    width:100%; 
    height:100%;
    background: rgba(0,0,0,0.5); 
    justify-content:center; 
    align-items:center; 
    z-index:70;
  }
  #scoreContentModal {
    background:white; 
    border-radius:16px; 
    padding:25px; 
    width:95%; 
    max-width:800px; 
    max-height:90%; 
    overflow-y:auto; 
    position:relative;
    box-shadow: 0 15px 40px rgba(0,0,0,0.25);
  }
  #scoreContentModal button.closeScore {
    position:absolute; 
    top:15px; 
    right:15px; 
    font-size:1.8rem; 
    font-weight:bold; 
    color:#ef4444;
    background: none;
    border: none;
    cursor: pointer;
  }
  /* Modal de Administración */
  #adminModal {
    display:none; 
    position:fixed; 
    top:0; 
    left:0; 
    width:100%; 
    height:100%;
    background: rgba(0,0,0,0.5); 
    justify-content:center; 
    align-items:center; 
    z-index:80;
  }
  #adminModalContent {
    background:white; 
    border-radius:16px; 
    padding:25px; 
    width:95%; 
    max-width:1000px; 
    max-height:90%; 
    overflow-y:auto; 
    position:relative;
    box-shadow: 0 15px 40px rgba(0,0,0,0.25);
  }
  #adminModalContent button.closeAdminModal {
    position:absolute; 
    top:15px; 
    right:15px; 
    font-size:1.8rem; 
    font-weight:bold; 
    color:#ef4444;
    background: none;
    border: none;
    cursor: pointer;
  }
  /* Modal para añadir partituras */
  #addScoreModal {
    display:none; 
    position:fixed; 
    top:0; 
    left:0; 
    width:100%; 
    height:100%;
    background: rgba(0,0,0,0.5); 
    justify-content:center; 
    align-items:center; 
    z-index:90;
  }
  #addScoreModalContent {
    background:white; 
    border-radius:16px; 
    padding:25px; 
    width:95%; 
    max-width:600px; 
    max-height:90%; 
    overflow-y:auto; 
    position:relative;
    box-shadow: 0 15px 40px rgba(0,0,0,0.25);
  }
  #addScoreModalContent button.closeAddScoreModal {
    position:absolute; 
    top:15px; 
    right:15px; 
    font-size:1.8rem; 
    font-weight:bold; 
    color:#ef4444;
    background: none;
    border: none;
    cursor: pointer;
  }
  /* Modal de vista ampliada de PDF */
  #pdfViewerModal {
    display:none; 
    position:fixed; 
    top:0; 
    left:0; 
    width:100%; 
    height:100%;
    background: rgba(0,0,0,0.9); 
    justify-content:center; 
    align-items:center; 
    z-index:100;
  }
  #pdfViewerContent {
    background:white; 
    border-radius:8px; 
    padding:20px; 
    width:95%; 
    max-width:900px; 
    max-height:90%; 
    overflow:auto; 
    position:relative;
  }
  #pdfViewerContent button.closePdfViewer {
    position:absolute; 
    top:10px; 
    right:10px; 
    font-size:1.8rem; 
    font-weight:bold; 
    color:#ef4444;
    background: none;
    border: none;
    cursor: pointer;
    z-index:101;
  }
  /* Estilos para la barra de búsqueda */
  .search-container {
    position: relative;
    display: inline-block;
  }
  .search-container i {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #7c3aed;
  }
  .search-container input {
    padding-left: 40px;
    border-radius: 50px;
    border: 2px solid #e5e7eb;
    transition: all 0.3s;
  }
  .search-container input:focus {
    border-color: #7c3aed;
    outline: none;
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
  }
  /* Botones mejorados */
  .btn-primary {
    background: #7c3aed;
    color: white;
    border-radius: 8px;
    padding: 8px 16px;
    font-weight: 600;
    transition: all 0.3s;
  }
  .btn-primary:hover {
    background: #6d28d9;
    transform: translateY(-2px);
  }
  .btn-secondary {
    background: white;
    color: #7c3aed;
    border: 2px solid #7c3aed;
    border-radius: 8px;
    padding: 8px 16px;
    font-weight: 600;
    transition: all 0.3s;
  }
  .btn-secondary:hover {
    background: #f5f3ff;
  }
  /* Mejora para los comentarios */
  .comment {
    border-left: 4px solid #7c3aed;
    padding-left: 12px;
    margin-bottom: 12px;
    background: #faf7ff;
    border-radius: 0 8px 8px 0;
  }
  /* Animación de carga */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .fade-in {
    animation: fadeIn 0.5s ease forwards;
  }
  /* Scroll personalizado */
  ::-webkit-scrollbar {
    width: 8px;
  }
  ::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
  }
  ::-webkit-scrollbar-thumb {
    background: #c4b5fd;
    border-radius: 10px;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: #7c3aed;
  }
  /* Mejoras para el modal de partituras */
  .score-details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }
  @media (max-width: 768px) {
    .score-details-grid {
      grid-template-columns: 1fr;
    }
  }
  .download-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    margin-left: 8px;
  }
  .download-badge.completed {
    background-color: #10b981;
    color: white;
  }
  .download-badge.pending {
    background-color: #f59e0b;
    color: white;
  }
  .score-info-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
  }
  .score-info-item i {
    width: 20px;
    margin-right: 10px;
    color: #7c3aed;
  }
  /* Vista previa de PDF */
  .pdf-preview-container {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    overflow-x: auto;
    padding-bottom: 10px;
  }
  .pdf-page {
    border: 1px solid #ddd;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    background: white;
    cursor: pointer;
    transition: transform 0.2s;
  }
  .pdf-page:hover {
    transform: scale(1.05);
  }
  .pdf-page canvas {
    max-width: 200px;
    height: auto;
  }
  .pdf-page-number {
    text-align: center;
    padding: 5px;
    font-size: 12px;
    color: #666;
    background: #f5f5f5;
  }
  /* Tabla de administración */
  .admin-table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0;
  }
  .admin-table th, .admin-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #eee;
  }
  .admin-table th {
    background-color: #f8f5ff;
    font-weight: 600;
    color: #7c3aed;
  }
  .admin-table tr:hover {
    background-color: #f9f7ff;
  }
  /* Formularios */
  .form-group {
    margin-bottom: 15px;
  }
  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #4b5563;
  }
  .form-group input, .form-group textarea, .form-group select {
    width: 100%;
    padding: 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 16px;
  }
  .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
    outline: none;
    border-color: #7c3aed;
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
  }
  /* Botón de cambio de vista */
  #viewToggleBtn {
    position: fixed;
    top: 100px; /* Ajustado para evitar superposición */
    right: 20px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #7c3aed;
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.2rem;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    cursor: pointer;
    z-index: 40;
    transition: all 0.3s ease;
  }
  #viewToggleBtn:hover {
    transform: scale(1.1);
    background: #6d28d9;
  }
  /* Vista de lista */
  .list-view {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  .list-view .card {
    display: flex;
    flex-direction: row;
    height: auto;
  }
  .list-view .card img {
    width: 200px;
    height: 150px;
    object-fit: contain;
    margin-right: 20px;
  }
  .list-view .card-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  /* Indicador de carga */
  .loader {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #7c3aed;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  /* Barra de progreso */
  .progress-bar {
    width: 100%;
    height: 6px;
    background-color: #e5e7eb;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 5px;
  }
  .progress-bar-fill {
    height: 100%;
    background-color: #7c3aed;
    transition: width 0.3s ease;
  }
  /* Notificaciones */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateX(100%);
    transition: transform 0.3s ease;
  }
  .notification.show {
    transform: translateX(0);
  }
  .notification.success {
    background-color: #10b981;
  }
  .notification.error {
    background-color: #ef4444;
  }
  .notification.info {
    background-color: #3b82f6;
  }
  .notification.warning {
    background-color: #f59e0b;
  }
  /* Selector de moneda */
  .currency-selector {
    display: flex;
    align-items: center;
    background: white;
    border-radius: 50px;
    padding: 4px 8px;
    border: 2px solid #e5e7eb;
    margin-left: 10px;
  }
  .currency-selector select {
    border: none;
    outline: none;
    background: transparent;
    font-size: 14px;
    font-weight: 600;
    color: #7c3aed;
    cursor: pointer;
  }
  /* Etiqueta de género */
  .genre-badge {
    display: inline-block;
    background-color: #8b5cf6;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    margin-top: 5px;
  }
  /* Modal de edición de partitura */
  #editScoreModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 95;
  }
  #editScoreModalContent {
    background: white;
    border-radius: 16px;
    padding: 25px;
    width: 95%;
    max-width: 800px;
    max-height: 90%;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 15px 40px rgba(0,0,0,0.25);
  }
  #editScoreModalContent button.closeEditScoreModal {
    position: absolute;
    top: 15px;
    right: 15px;
    font-size: 1.8rem;
    font-weight: bold;
    color: #ef4444;
    background: none;
    border: none;
    cursor: pointer;
  }
  /* Previsualización de archivos */
  .file-preview {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    padding: 10px;
    background: #f9fafb;
    border-radius: 8px;
  }
  .file-preview img {
    width: 50px;
    height: 50px;
    object-fit: cover;
    margin-right: 10px;
    border-radius: 4px;
  }
  .file-preview audio {
    width: 100%;
    margin-top: 5px;
  }
  .file-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }
  /* Paginación */
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 30px;
    gap: 10px;
    flex-wrap: wrap;
  }
  .pagination button {
    padding: 8px 16px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    background: white;
    cursor: pointer;
    transition: all 0.3s;
  }
  .pagination button:hover:not(:disabled) {
    background: #7c3aed;
    color: white;
    border-color: #7c3aed;
  }
  .pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .pagination .page-numbers {
    display: flex;
    gap: 5px;
  }
  .pagination .page-btn {
    min-width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    background: white;
    cursor: pointer;
    transition: all 0.3s;
  }
  .pagination .page-btn.active {
    background: #7c3aed;
    color: white;
    border-color: #7c3aed;
  }
  .pagination .page-btn:hover:not(.active) {
    background: #f3f4f6;
  }
  .pagination-info {
    margin: 0 15px;
    font-weight: 600;
    color: #4b5563;
  }
  @media (max-width: 640px) {
    .pagination {
      flex-direction: column;
      gap: 15px;
    }
    .pagination .page-numbers {
      order: 3;
      margin-top: 10px;
    }
  }
  
  /* ========== NUEVOS ESTILOS PARA LAS MEJORAS ========== */
  
  /* Sistema de votación con estrellas */
  .star-rating {
    display: flex;
    align-items: center;
    gap: 5px;
    margin: 8px 0;
  }
  
  .star {
    font-size: 18px;
    color: #d1d5db;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .star:hover {
    transform: scale(1.2);
  }
  
  .star.active {
    color: #fbbf24;
  }
  
  .star.animated {
    animation: starPulse 0.5s ease;
  }
  
  @keyframes starPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
  }
  
  .rating-info {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 10px 0;
    flex-wrap: wrap;
  }
  
  .rating-display {
    display: flex;
    align-items: center;
    gap: 5px;
  }
  
  .rating-value {
    font-weight: bold;
    color: #7c3aed;
  }
  
  .rating-count {
    font-size: 12px;
    color: #6b7280;
  }
  
  .personal-rating {
    background: #f0f9ff;
    padding: 8px 12px;
    border-radius: 8px;
    border-left: 3px solid #7c3aed;
  }
  
  .average-rating {
    background: #fef7ff;
    padding: 8px 12px;
    border-radius: 8px;
    border-left: 3px solid #fbbf24;
  }
  
  /* Campo de género personalizado */
  .custom-genre-input {
    margin-top: 10px;
    transition: all 0.3s ease;
    overflow: hidden;
  }
  
  .custom-genre-input.hidden {
    max-height: 0;
    opacity: 0;
    margin-top: 0;
  }
  
  .custom-genre-input.visible {
    max-height: 100px;
    opacity: 1;
  }
  
  /* Etiquetas de búsqueda */
  .search-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
  }
  
  .search-tag {
    background: #e0e7ff;
    color: #3730a3;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .search-tag:hover {
    background: #c7d2fe;
    transform: translateY(-1px);
  }
  
  .hashtag {
    background: #f3e8ff;
    color: #7c3aed;
  }
  
  /* Mejoras de búsqueda */
  .search-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    z-index: 100;
    max-height: 200px;
    overflow-y: auto;
    display: none;
  }
  
  .search-suggestions.visible {
    display: block;
  }
  
  .suggestion-item {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #f3f4f6;
  }
  
  .suggestion-item:hover {
    background: #f9fafb;
  }
  
  .suggestion-item:last-child {
    border-bottom: none;
  }

/* ======= AJUSTES RESPONSIVOS Y NUEVAS FUNCIONALIDADES ======= */
/* Forzar que el main tenga espacio bajo el header (se ajusta también vía JS) */
main { transition: padding-top 0.18s ease; }

/* Mobile: ocultar botones del header (se clonarán al sidebar) */
@media (max-width: 768px) {
  header .flex.items-center > :not(.search-container):not(.currency-selector) {
    display: none !important;
  }
}

/* Botón Hamburger visible en móvil */
#hamburgerBtn { display: none; background: none; border: none; color: inherit; font-size: 1.25rem; margin-left: 8px; }
@media (max-width: 768px) { #hamburgerBtn { display: inline-flex; align-items:center; justify-content:center; } }

/* Sidebar móvil */
#sidebarOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:110; transition: opacity 0.25s ease; }
#sidebarOverlay.show { display:block; }
#mobileSidebar { position:fixed; top:0; right:0; height:100vh; width:0; background: #ffffff; box-shadow: -10px 0 30px rgba(0,0,0,0.12); overflow:hidden; transition: width 0.28s ease; z-index:120; }
#mobileSidebar.open { width: 280px; }
#mobileSidebar .sidebar-inner { padding: 20px; font-family: inherit; }
#mobileSidebar .sidebar-inner .btn-secondary { display:block; width:100%; text-align:left; margin-bottom:8px; }
#mobileSidebar .sidebar-inner .user-info { margin-bottom:12px; font-weight:600; color:#4b5563; }

/* Botón flotante Añadir (solo visible para admin; se mostrará por JS) */
#floatingAddBtn { position: fixed; bottom: 20px; right: 96px; width: 56px; height: 56px; border-radius: 50%; background:#10b981; color:#fff; display:none; align-items:center; justify-content:center; z-index:130; box-shadow: 0 10px 28px rgba(16,185,129,0.18); cursor:pointer; }
#floatingAddBtn.show { display:flex; }
#floatingAddBtn i { font-size: 1.2rem; }

/* Ajuste para que el carrito no tape elementos en pantallas muy pequeñas */
@media (max-width: 420px) {
  #cartBtn { right: 16px; bottom: 16px; width:52px; height:52px; }
  #floatingAddBtn { right: 84px; bottom: 16px; width:52px; height:52px; }
}

/* Chips para etiquetas */
.search-tags { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
.search-tag, .tag-chip { background:#eef2ff; color:#3c2b9e; padding:6px 10px; border-radius:999px; font-weight:600; display:inline-flex; align-items:center; gap:8px; }
.search-tag .remove-tag, .tag-chip .remove-tag { cursor:pointer; padding-left:6px; font-weight:700; color:#9f7aea; }

/* Mejor comportamiento de modales en móvil */
#scoreContentModal, #addScoreModalContent, #editScoreModalContent, #adminModalContent, #pdfViewerContent, #profileContent {
  box-sizing: border-box;
  max-height: calc(100vh - 120px);
  overflow-y: auto;
}

/* Small polish */
.header { z-index: 100; }
</style>
</head>
<body>

<header class="header bg-gradient-to-r from-purple-700 via-purple-500 to-purple-400 text-white p-4 flex flex-wrap justify-between items-center">
  <h1 class="text-xl font-bold flex items-center">
    <i class="fas fa-music mr-2"></i>MyScoreBuy
  </h1>
  <div class="flex items-center mt-2 md:mt-0 flex-wrap gap-2">
    <div class="search-container">
      <i class="fas fa-search"></i>
      <input type="text" id="search" placeholder="Buscar partituras, #jazz, #clásica..." class="p-2 rounded text-black w-full md:w-64">
      <div id="searchSuggestions" class="search-suggestions"></div>
    </div>
    
    <!-- Selector de moneda -->
    <div class="currency-selector">
      <select id="currencySelector">
        <option value="CUP">CUP $</option>
        <option value="USD">USD $</option>
        <option value="EUR">EUR €</option>
        <option value="GBP">GBP £</option>
        <option value="MXN">MXN $</option>
      </select>
    </div>
    
    <button id="loginBtn" class="btn-secondary ml-2"><i class="fas fa-sign-in-alt mr-1"></i>Iniciar Sesión</button>
    <button id="signupBtn" class="btn-secondary ml-2"><i class="fas fa-user-plus mr-1"></i>Registrarse</button>
    <button id="ordersBtn" class="btn-secondary ml-2 hidden"><i class="fas fa-history mr-1"></i>Pedidos</button>
    <button id="adminBtn" class="btn-secondary ml-2 hidden"><i class="fas fa-cog mr-1"></i>Admin</button>
    <button id="catalogBtn" class="btn-secondary ml-2 hidden"><i class="fas fa-th-list mr-1"></i>Catálogo</button>
    <button id="profileBtn" class="btn-secondary ml-2 hidden"><i class="fas fa-user-circle mr-1"></i>Perfil</button>
    <button id="addScoreBtn" class="btn-secondary ml-2 hidden"><i class="fas fa-plus-circle mr-1"></i>Añadir Partitura</button>
  </div>
</header>
<!-- Mobile hamburger + sidebar (insertado automáticamente por el asistente) -->
<button id="hamburgerBtn" aria-label="Abrir menú" class="md:hidden ml-2"><i class="fas fa-bars"></i></button>
<div id="sidebarOverlay"></div>
<div id="mobileSidebar" aria-hidden="true">
  <div class="sidebar-inner">
    <button class="close-sidebar" aria-label="Cerrar menú" style="font-size:1.5rem;background:none;border:none;display:block;margin-left:auto;">&times;</button>
    <div class="user-info" id="mobileUserArea"></div>
    <nav id="mobileMenuButtons" class="flex flex-col gap-2 mt-2"></nav>
  </div>
</div>


<!-- ========== NUEVO MODAL DE AUTENTICACIÓN ========== -->
<div id="authModal" class="flex">
  <div class="auth-box">
    <button class="close-auth">&times;</button>
    <div class="auth-content">
      <div class="auth-tabs">
        <div class="auth-tab active" data-tab="login">Iniciar Sesión</div>
        <div class="auth-tab" data-tab="signup">Registrarse</div>
      </div>
      
      <div id="loginForm" class="auth-form active">
        <h3><i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesión</h3>
        <div class="auth-form-group">
          <label for="loginEmail">Correo Electrónico</label>
          <input type="email" id="loginEmail" placeholder="tu@correo.com" required>
          <div id="loginEmailError" class="auth-error"></div>
        </div>
        <div class="auth-form-group">
          <label for="loginPassword">Contraseña</label>
          <input type="password" id="loginPassword" placeholder="Tu contraseña" required>
          <div id="loginPasswordError" class="auth-error"></div>
        </div>
        <button id="loginSubmitBtn" class="auth-btn">
          <i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesión
        </button>
        <div id="loginSuccess" class="auth-success"></div>
      </div>
      
      <div id="signupForm" class="auth-form">
        <h3><i class="fas fa-user-plus mr-2"></i>Crear Cuenta</h3>
        <div class="auth-form-group">
          <label for="signupEmail">Correo Electrónico</label>
          <input type="email" id="signupEmail" placeholder="tu@correo.com" required>
          <div id="signupEmailError" class="auth-error"></div>
        </div>
        <div class="auth-form-group">
          <label for="signupPassword">Contraseña</label>
          <input type="password" id="signupPassword" placeholder="Mínimo 6 caracteres" required>
          <div id="signupPasswordError" class="auth-error"></div>
        </div>
        <div class="auth-form-group">
          <label for="signupPhone">Teléfono</label>
          <input type="tel" id="signupPhone" placeholder="Tu número de teléfono" required>
          <div id="signupPhoneError" class="auth-error"></div>
        </div>
        <button id="signupSubmitBtn" class="auth-btn">
          <i class="fas fa-user-plus mr-2"></i>Registrarse
        </button>
        <div id="signupSuccess" class="auth-success"></div>
      </div>
      
      <div class="auth-footer">
        <p>Al registrarte aceptas nuestros <a href="#">Términos y Condiciones</a></p>
      </div>
    </div>
  </div>
</div>

<!-- Botón de cambio de vista -->
<button id="viewToggleBtn" title="Cambiar vista">
  <i class="fas fa-th-large"></i>
</button>

<!-- Catálogo -->
<main id="catalog" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 p-4"></main>

<!-- Controles de paginación -->
<div id="pagination" class="pagination hidden">
  <button id="prevPageBtn" disabled>
    <i class="fas fa-chevron-left mr-1"></i> Anterior
  </button>
  <span class="pagination-info" id="pageInfo">Página 1 de 1</span>
  <button id="nextPageBtn" disabled>
    Siguiente <i class="fas fa-chevron-right ml-1"></i>
  </button>
  <div class="page-numbers" id="pageNumbers"></div>
</div>

<!-- Pedidos -->
<main id="ordersSection" class="hidden p-4">
  <h2 class="text-2xl font-bold mb-6 text-purple-800 flex items-center">
    <i class="fas fa-history mr-2"></i>Mis Pedidos
  </h2>
  <div id="ordersList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
</main>

<!-- Admin -->
<main id="adminSection" class="hidden p-4">
  <h2 class="text-2xl font-bold mb-6 text-purple-800 flex items-center">
    <i class="fas fa-cog mr-2"></i>Panel de Pedidos
  </h2>
  <div id="adminList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
</main>

<!-- Comentarios generales de la app -->
<main id="commentsSection" class="p-4">
  <h2 class="text-2xl font-bold mb-6 text-purple-800 flex items-center">
    <i class="fas fa-comments mr-2"></i>Comentarios Generales
  </h2>
  <div class="bg-white p-4 rounded-lg shadow-md mb-6">
    <textarea id="generalCommentInput" placeholder="Escribe tu comentario sobre la tienda..." class="w-full p-3 rounded border border-gray-300 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 mb-3"></textarea>
    <button id="sendGeneralCommentBtn" class="btn-primary w-full md:w-auto">
      <i class="fas fa-paper-plane mr-1"></i>Enviar Comentario
    </button>
  </div>
  <div id="generalCommentsList" class="flex flex-col gap-4"></div>
</main>

<!-- Carrito -->
<div id="cartBtn">
  <i class="fas fa-shopping-cart"></i>
  <span id="cartCount" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs hidden">0</span>
</div>
<div id="cartContainer">
  <h3 class="font-bold mb-4 text-lg text-purple-800 flex items-center">
    <i class="fas fa-shopping-cart mr-2"></i>Carrito
  </h3>
  <ul id="cart-list" class="mb-3"></ul>
  <p id="cartTotal" class="font-bold mb-3 text-lg hidden">Total: $0</p>
  <div id="paymentInfo" class="mb-3 p-3 bg-purple-50 rounded-lg hidden">
    <p class="font-semibold text-purple-800 mb-2">Información de pago:</p>
    <p><strong>Tarjeta:</strong> 9224 0699 9669 7302</p>
    <p><strong>Móvil:</strong> 59558767</p>
    <p class="text-red-600 font-bold mt-2 text-sm">⚠️ Una vez realizada la transferencia, envía un mensaje por WhatsApp con la captura del comprobante.</p>
  </div>
  <button id="sendOrderBtn" class="btn-primary w-full py-3 text-lg hidden">
    <i class="fas fa-paper-plane mr-2"></i>Enviar Pedido
  </button>
  <button id="clearCartBtn" class="btn-secondary w-full mt-2 hidden">
    <i class="fas fa-trash mr-2"></i>Vaciar Carrito
  </button>
</div>

<!-- Modal Perfil -->
<div id="profileModal" class="flex">
  <div id="profileContent" class="fade-in">
    <button class="closeProfile">&times;</button>
    <h2 class="text-2xl font-bold mb-4 text-purple-800 flex items-center">
      <i class="fas fa-user-circle mr-2"></i>Perfil
    </h2>
    <div class="mb-3">
      <p class="text-sm text-gray-600">Correo electrónico</p>
      <p id="profileEmail" class="font-medium"></p>
    </div>
    <div class="mb-4">
      <p class="text-sm text-gray-600">Teléfono</p>
      <p id="profilePhone" class="font-medium"></p>
    </div>
    <button id="profileSignOutBtn" class="btn-primary w-full">
      <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
    </button>
  </div>
</div>

<!-- Modal Partitura -->
<div id="scoreModal" class="flex">
  <div id="scoreContentModal" class="fade-in">
    <button class="closeScore">&times;</button>
    <div class="score-details-grid mb-6">
      <div>
        <img id="scorePreview" src="" alt="Vista previa" class="w-full h-64 object-contain rounded-lg shadow-md mb-4">
        <div id="pdfPreview" class="pdf-preview-container hidden"></div>
        <audio controls id="scoreAudio" class="w-full mb-4"></audio>
      </div>
      <div>
        <h2 id="scoreTitle" class="text-2xl font-bold text-purple-800 mb-2"></h2>
        <p id="scoreComposer" class="text-sm text-gray-600 mb-3"><i class="fas fa-user mr-1"></i>Compositor: <span class="font-medium"></span></p>
        <p id="scorePrice" class="text-xl font-bold mb-4 text-purple-700"></p>
        
        <!-- Mostrar género en el modal -->
        <div id="scoreGenre" class="mb-2">
          <span class="genre-badge"><i class="fas fa-tag mr-1"></i><span id="scoreGenreText"></span></span>
        </div>
        
        <!-- Sistema de votación en el modal -->
        <div id="scoreRatingSection" class="mb-4">
          <h3 class="text-lg font-semibold mb-2 text-purple-800">Valoraciones</h3>
          
          <!-- Votación personal del usuario -->
          <div id="personalRatingSection" class="personal-rating mb-3 hidden">
            <p class="text-sm font-medium mb-1">Tu valoración:</p>
            <div class="star-rating" id="userStarRating">
              <!-- Las estrellas se generarán dinámicamente -->
            </div>
          </div>
          
          <!-- Promedio general -->
          <div class="average-rating">
            <div class="rating-info">
              <div class="rating-display">
                <div id="averageStars">
                  <!-- Estrellas de promedio se generarán dinámicamente -->
                </div>
                <span class="rating-value" id="averageRatingValue">0.0</span>
              </div>
              <span class="rating-count" id="totalVotesCount">(0 votos)</span>
            </div>
          </div>
        </div>
        
        <div id="scoreDescription" class="mb-4 text-gray-700"></div>
        
        <div id="scoreDetails" class="mb-4 p-4 bg-purple-50 rounded-lg">
          <div class="score-info-item">
            <i class="fas fa-clock"></i>
            <span>Duración: </span>
            <span id="scoreDuration" class="font-medium">--:--</span>
          </div>
          <div class="score-info-item">
            <i class="fas fa-sliders-h"></i>
            <span>Dificultad: </span>
            <span id="scoreDifficulty" class="font-medium">--</span>
          </div>
          <div class="score-info-item">
            <i class="fas fa-music"></i>
            <span>Instrumento: </span>
            <span id="scoreInstrument" class="font-medium">--</span>
          </div>
          <div class="score-info-item">
            <i class="fas fa-file-alt"></i>
            <span>Páginas: </span>
            <span id="scorePages" class="font-medium">--</span>
          </div>
        </div>
        
        <button id="addToCartModalBtn" class="btn-primary w-full py-3">
          <i class="fas fa-cart-plus mr-2"></i>Añadir al Carrito
        </button>
      </div>
    </div>
    
    <div class="border-t pt-6">
      <h3 class="text-xl font-bold mb-4 text-purple-800 flex items-center">
        <i class="fas fa-comments mr-2"></i>Comentarios de esta Partitura
      </h3>
      <div class="bg-white p-4 rounded-lg shadow-md mb-4">
        <textarea id="scoreCommentInput" placeholder="Escribe tu comentario sobre esta partitura..." class="w-full p-3 rounded border border-gray-300 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 mb-3"></textarea>
        <button id="scoreSendCommentBtn" class="btn-primary w-full md:w-auto">
          <i class="fas fa-paper-plane mr-1"></i>Enviar Comentario
        </button>
      </div>
      <div id="scoreCommentsList" class="flex flex-col gap-4"></div>
    </div>
  </div>
</div>

<!-- Modal de Administración -->
<div id="adminModal" class="flex">
  <div id="adminModalContent" class="fade-in">
    <button class="closeAdminModal">&times;</button>
    <h2 class="text-2xl font-bold mb-6 text-purple-800 flex items-center">
      <i class="fas fa-cog mr-2"></i>Panel de Administración
    </h2>
    
    <div class="mb-6">
      <h3 class="text-xl font-bold mb-4 text-purple-700 flex items-center">
        <i class="fas fa-check-circle mr-2"></i>Aprobar Pedidos
      </h3>
      <div class="overflow-x-auto">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Partitura</th>
              <th>Fecha</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="adminOrdersTable">
            <!-- Los pedidos se cargarán aquí -->
          </tbody>
        </table>
      </div>
    </div>

    <div class="mb-6">
      <h3 class="text-xl font-bold mb-4 text-purple-700 flex items-center">
        <i class="fas fa-users mr-2"></i>Usuarios Registrados
      </h3>
      <div class="overflow-x-auto">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Email</th>
              <th>Teléfono</th>
              <th>Fecha Registro</th>
              <th>Verificado</th>
            </tr>
          </thead>
          <tbody id="adminUsersTable">
            <!-- Los usuarios se cargarán aquí -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal para añadir partituras -->
<div id="addScoreModal" class="flex">
  <div id="addScoreModalContent" class="fade-in">
    <button class="closeAddScoreModal">&times;</button>
    <h2 class="text-2xl font-bold mb-6 text-purple-800 flex items-center">
      <i class="fas fa-plus-circle mr-2"></i>Añadir Nueva Partitura
    </h2>
    
    <form id="addScoreForm">
      <div class="form-group">
        <label for="scoreTitleInput">Título *</label>
        <input type="text" id="scoreTitleInput" required>
      </div>
      
      <div class="form-group">
        <label for="scoreComposerInput">Compositor *</label>
        <input type="text" id="scoreComposerInput" required>
      </div>
      
      <div class="form-group">
        <label for="scorePriceInput">Precio (CUP) *</label>
        <input type="number" id="scorePriceInput" min="0" step="0.01" required>
      </div>
      
      <!-- Campo de género mejorado -->
      <div class="form-group">
        <label for="scoreGenreInput">Género *</label>
        <select id="scoreGenreInput" required>
          <option value="">Seleccionar género</option>
          <option value="Clásica">Clásica</option>
          <option value="Jazz">Jazz</option>
          <option value="Pop">Pop</option>
          <option value="Rock">Rock</option>
          <option value="Folk">Folk</option>
          <option value="Bandas Sonoras">Bandas Sonoras</option>
          <option value="Otro">Otro</option>
        </select>
        <!-- Campo para género personalizado -->
        <div id="customGenreContainer" class="custom-genre-input hidden">
          <input type="text" id="customGenreInput" placeholder="Escribe el género personalizado..." class="mt-2">
        </div>
      </div>
      
      <!-- Campo de etiquetas para búsqueda -->
      <div class="form-group">
        <label for="scoreTagsInput">Etiquetas de búsqueda (separadas por comas)</label>
        <input type="text" id="scoreTagsInput" placeholder="Ej: jazz, clásica, piano, #estructura_jazz">
        <div class="text-sm text-gray-600 mt-1">
          <i class="fas fa-info-circle mr-1"></i>
          Estas etiquetas ayudarán a los usuarios a encontrar la partitura incluso si no coincide exactamente con el género.
        </div>
      </div>
      
      <div class="form-group">
        <label for="scoreDescriptionInput">Descripción</label>
        <textarea id="scoreDescriptionInput" rows="3"></textarea>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="form-group">
          <label for="scoreDifficultyInput">Dificultad</label>
          <select id="scoreDifficultyInput">
            <option value="Fácil">Fácil</option>
            <option value="Media" selected>Media</option>
            <option value="Difícil">Difícil</option>
            <option value="Avanzada">Avanzada</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="scoreInstrumentInput">Instrumento</label>
          <input type="text" id="scoreInstrumentInput">
        </div>
        
        <div class="form-group">
          <label for="scorePagesInput">Número de páginas</label>
          <input type="number" id="scorePagesInput" min="1">
        </div>
        
        <div class="form-group">
          <label for="scoreDurationInput">Duración (mm:ss)</label>
          <input type="text" id="scoreDurationInput" placeholder="Ej: 3:45">
        </div>
      </div>

      <div class="form-group">
        <label for="scoreMxlFile">Archivo MXL/XML (para extraer instrumentos automáticamente)</label>
        <input type="file" id="scoreMxlFile" accept=".mxl,.xml">
        <div class="progress-bar hidden" id="mxlProgressBar">
          <div class="progress-bar-fill" style="width: 0%"></div>
        </div>
        <button type="button" id="extractInstrumentsBtn" class="btn-secondary mt-2 hidden">
          <i class="fas fa-magic mr-1"></i>Extraer instrumentos
        </button>
        <div id="extractedInstruments" class="mt-2 p-2 bg-purple-50 rounded hidden">
          <p class="text-sm font-semibold mb-1">Instrumentos detectados:</p>
          <div id="instrumentsList"></div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="scoreCoverFile">Carátula (Imagen) *</label>
        <input type="file" id="scoreCoverFile" accept="image/*" required>
        <div class="progress-bar hidden" id="coverProgressBar">
          <div class="progress-bar-fill" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="scorePdfFile">Archivo PDF *</label>
        <input type="file" id="scorePdfFile" accept=".pdf" required>
        <div class="progress-bar hidden" id="pdfProgressBar">
          <div class="progress-bar-fill" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="scoreAudioFile">Audio (MP3)</label>
        <input type="file" id="scoreAudioFile" accept="audio/*">
        <div class="progress-bar hidden" id="audioProgressBar">
          <div class="progress-bar-fill" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="scoreMidiFile">Archivo MIDI</label>
        <input type="file" id="scoreMidiFile" accept=".mid,.midi">
        <div class="progress-bar hidden" id="midiProgressBar">
          <div class="progress-bar-fill" style="width: 0%"></div>
        </div>
      </div>
      
      <button type="submit" class="btn-primary w-full py-3 mt-4" id="submitScoreBtn">
        <i class="fas fa-save mr-2"></i>Guardar Partitura
      </button>
    </form>
  </div>
</div>

<!-- Modal de vista ampliada de PDF -->
<div id="pdfViewerModal" class="flex">
  <div id="pdfViewerContent" class="fade-in">
    <button class="closePdfViewer">&times;</button>
    <div id="pdfViewerContainer" class="mt-4">
      <!-- El PDF se cargará aquí -->
    </div>
    <div class="flex justify-center mt-4 gap-2">
      <button id="prevPage" class="btn-secondary">
        <i class="fas fa-chevron-left mr-1"></i>Anterior
      </button>
      <span id="pageInfo" class="mx-3 flex items-center">Página 1 de 1</span>
      <button id="nextPage" class="btn-secondary">
        Siguiente<i class="fas fa-chevron-right ml-1"></i>
      </button>
    </div>
  </div>
</div>

<!-- Modal de edición de partitura -->
<div id="editScoreModal" class="flex">
  <div id="editScoreModalContent" class="fade-in">
    <button class="closeEditScoreModal">&times;</button>
    <h2 class="text-2xl font-bold mb-6 text-purple-800 flex items-center">
      <i class="fas fa-edit mr-2"></i>Editar Partitura
    </h2>
    
    <form id="editScoreForm">
      <input type="hidden" id="editScoreId">
      
      <div class="form-group">
        <label for="editScoreTitle">Título *</label>
        <input type="text" id="editScoreTitle" required>
      </div>
      
      <div class="form-group">
        <label for="editScoreComposer">Compositor *</label>
        <input type="text" id="editScoreComposer" required>
      </div>
      
      <div class="form-group">
        <label for="editScorePrice">Precio (CUP) *</label>
        <input type="number" id="editScorePrice" min="0" step="0.01" required>
      </div>
      
      <!-- Campo de género mejorado -->
      <div class="form-group">
        <label for="editScoreGenre">Género *</label>
        <select id="editScoreGenre" required>
          <option value="">Seleccionar género</option>
          <option value="Clásica">Clásica</option>
          <option value="Jazz">Jazz</option>
          <option value="Pop">Pop</option>
          <option value="Rock">Rock</option>
          <option value="Folk">Folk</option>
          <option value="Bandas Sonoras">Bandas Sonoras</option>
          <option value="Otro">Otro</option>
        </select>
        <!-- Campo para género personalizado -->
        <div id="editCustomGenreContainer" class="custom-genre-input hidden">
          <input type="text" id="editCustomGenreInput" placeholder="Escribe el género personalizado..." class="mt-2">
        </div>
      </div>
      
      <!-- Campo de etiquetas para búsqueda -->
      <div class="form-group">
        <label for="editScoreTags">Etiquetas de búsqueda (separadas por comas)</label>
        <input type="text" id="editScoreTags" placeholder="Ej: jazz, clásica, piano, #estructura_jazz">
      </div>
      
      <div class="form-group">
        <label for="editScoreDescription">Descripción</label>
        <textarea id="editScoreDescription" rows="3"></textarea>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="form-group">
          <label for="editScoreDifficulty">Dificultad</label>
          <select id="editScoreDifficulty">
            <option value="Fácil">Fácil</option>
            <option value="Media">Media</option>
            <option value="Difícil">Difícil</option>
            <option value="Avanzada">Avanzada</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="editScoreInstrument">Instrumento</label>
          <input type="text" id="editScoreInstrument">
        </div>
        
        <div class="form-group">
          <label for="editScorePages">Número de páginas</label>
          <input type="number" id="editScorePages" min="1">
        </div>
        
        <div class="form-group">
          <label for="editScoreDuration">Duración (mm:ss)</label>
          <input type="text" id="editScoreDuration" placeholder="Ej: 3:45">
        </div>
      </div>
      
      <!-- Previsualización y gestión de archivos -->
      <div class="form-group">
        <label>Carátula actual</label>
        <div class="file-preview">
          <img id="editScoreCurrentCover" src="" alt="Carátula actual">
          <div>
            <p class="text-sm font-medium">Carátula</p>
            <button type="button" class="btn-secondary mt-1" onclick="document.getElementById('editScoreCoverFile').click()">
              <i class="fas fa-upload mr-1"></i>Cambiar
            </button>
          </div>
        </div>
        <input type="file" id="editScoreCoverFile" accept="image/*" class="hidden">
      </div>
      
      <div class="form-group">
        <label>Archivo PDF actual</label>
        <div class="file-preview">
          <i class="fas fa-file-pdf text-4xl text-red-500 mr-3"></i>
          <div>
            <p class="text-sm font-medium">Documento PDF</p>
            <button type="button" class="btn-secondary mt-1" onclick="document.getElementById('editScorePdfFile').click()">
              <i class="fas fa-upload mr-1"></i>Cambiar
            </button>
          </div>
        </div>
        <input type="file" id="editScorePdfFile" accept=".pdf" class="hidden">
      </div>
      
      <div class="form-group">
        <label>Archivo de audio actual</label>
        <div id="editScoreAudioPreview" class="file-preview">
          <i class="fas fa-file-audio text-4xl text-blue-500 mr-3"></i>
          <div>
            <p class="text-sm font-medium">Audio</p>
            <div class="file-actions">
              <button type="button" class="btn-secondary" onclick="document.getElementById('editScoreAudioFile').click()">
                <i class="fas fa-upload mr-1"></i>Cambiar
              </button>
              <button type="button" class="btn-secondary" id="removeAudioBtn">
                <i class="fas fa-trash mr-1"></i>Eliminar
              </button>
            </div>
          </div>
        </div>
        <audio id="editScoreCurrentAudio" controls class="w-full mt-2 hidden"></audio>
        <input type="file" id="editScoreAudioFile" accept="audio/*" class="hidden">
      </div>
      
      <div class="form-group">
        <label>Archivo MIDI actual</label>
        <div id="editScoreMidiPreview" class="file-preview">
          <i class="fas fa-music text-4xl text-purple-500 mr-3"></i>
          <div>
            <p class="text-sm font-medium">Archivo MIDI</p>
            <div class="file-actions">
              <button type="button" class="btn-secondary" onclick="document.getElementById('editScoreMidiFile').click()">
                <i class="fas fa-upload mr-1"></i>Cambiar
              </button>
              <button type="button" class="btn-secondary" id="removeMidiBtn">
                <i class="fas fa-trash mr-1"></i>Eliminar
              </button>
            </div>
          </div>
        </div>
        <input type="file" id="editScoreMidiFile" accept=".mid,.midi" class="hidden">
      </div>
      
      <button type="submit" class="btn-primary w-full py-3 mt-4">
        <i class="fas fa-save mr-2"></i>Guardar Cambios
      </button>
    </form>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabaseUrl = "https://psljvtedkopmnnbukfxd.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBzbGp2dGVka29wbW5uYnVrZnhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0MDQyMDgsImV4cCI6MjA3MTk4MDIwOH0.HDAvJs0MxY16cudkVJG-5qYGFOYHPjK2eQMmnSfgztA"; 
const supabase = createClient(supabaseUrl, supabaseKey);

let user=null, cart=[], catalog=[];
let currentScoreId=null;
let currentView = 'grid'; // 'grid' or 'list'
let currentPdf = null;
let currentPage = 1;
let totalPages = 1;
let exchangeRates = {};
let selectedCurrency = 'CUP';

// Variables para paginación
let currentCatalogPage = 1;
const itemsPerPage = 12;
let totalCatalogPages = 1;
let filteredCatalog = [];

// Configuración de PDF.js
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

// Configuración de Tailwind
tailwind.config = {
  theme: {
    extend: {
      colors: {
        primary: '#7c3aed',
        secondary: '#6d28d9',
        accent: '#8b5cf6',
        light: '#f5f3ff',
        dark: '#1f2937'
      }
    }
  }
};

// Referencias a elementos DOM
const catalogEl=document.getElementById('catalog');
const ordersSection=document.getElementById('ordersSection');
const ordersList=document.getElementById('ordersList');
const adminSection=document.getElementById('adminSection');
const adminList=document.getElementById('adminList');
const paginationEl = document.getElementById('pagination');
const prevPageBtn = document.getElementById('prevPageBtn');
const nextPageBtn = document.getElementById('nextPageBtn');
const pageInfoEl = document.getElementById('pageInfo');
const pageNumbersEl = document.getElementById('pageNumbers');

const cartList=document.getElementById('cart-list');
const cartTotal=document.getElementById('cartTotal');
const paymentInfo=document.getElementById('paymentInfo');
const sendOrderBtn=document.getElementById('sendOrderBtn');
const clearCartBtn=document.getElementById('clearCartBtn');
const cartCount=document.getElementById('cartCount');

const loginBtn=document.getElementById('loginBtn');
const signupBtn=document.getElementById('signupBtn');
const profileBtn=document.getElementById('profileBtn');
const ordersBtn=document.getElementById('ordersBtn');
const adminBtn=document.getElementById('adminBtn');
const catalogBtn=document.getElementById('catalogBtn');
const addScoreBtn=document.getElementById('addScoreBtn');
const searchInput=document.getElementById('search');
const viewToggleBtn=document.getElementById('viewToggleBtn');
const currencySelector = document.getElementById('currencySelector');
const searchSuggestions = document.getElementById('searchSuggestions');

const cartBtn=document.getElementById('cartBtn');
const cartContainer=document.getElementById('cartContainer');
cartBtn.addEventListener('click', ()=>{cartContainer.style.display=cartContainer.style.display==='none'?'block':'none';});

// ========== NUEVO SISTEMA DE AUTENTICACIÓN ==========

// Referencias al nuevo modal de autenticación
const authModal = document.getElementById('authModal');
const authTabs = document.querySelectorAll('.auth-tab');
const loginForm = document.getElementById('loginForm');
const signupForm = document.getElementById('signupForm');
const closeAuthBtn = document.querySelector('.close-auth');
const loginSubmitBtn = document.getElementById('loginSubmitBtn');
const signupSubmitBtn = document.getElementById('signupSubmitBtn');

// Función para mostrar el modal de autenticación
function showAuthModal(initialTab = 'login') {
  authModal.style.display = 'flex';
  switchTab(initialTab);
}

// Función para cambiar entre pestañas
function switchTab(tabName) {
  // Actualizar pestañas activas
  authTabs.forEach(tab => {
    if (tab.dataset.tab === tabName) {
      tab.classList.add('active');
    } else {
      tab.classList.remove('active');
    }
  });
  
  // Mostrar formulario activo
  if (tabName === 'login') {
    loginForm.classList.add('active');
    signupForm.classList.remove('active');
  } else {
    loginForm.classList.remove('active');
    signupForm.classList.add('active');
  }
  
  // Limpiar mensajes de error
  clearAuthErrors();
}

// Función para limpiar mensajes de error
function clearAuthErrors() {
  document.querySelectorAll('.auth-error').forEach(el => {
    el.style.display = 'none';
    el.textContent = '';
  });
  document.querySelectorAll('.auth-success').forEach(el => {
    el.style.display = 'none';
    el.textContent = '';
  });
}

// Función para mostrar error en formulario
function showAuthError(fieldId, message) {
  const errorEl = document.getElementById(fieldId);
  errorEl.textContent = message;
  errorEl.style.display = 'block';
}

// Función para mostrar éxito en formulario
function showAuthSuccess(formId, message) {
  const successEl = document.getElementById(formId);
  successEl.textContent = message;
  successEl.style.display = 'block';
}

// Event listeners para pestañas
authTabs.forEach(tab => {
  tab.addEventListener('click', () => {
    switchTab(tab.dataset.tab);
  });
});

// Cerrar modal de autenticación
closeAuthBtn.addEventListener('click', () => {
  authModal.style.display = 'none';
  clearAuthErrors();
});

// Cerrar modal al hacer clic fuera
authModal.addEventListener('click', (e) => {
  if (e.target === authModal) {
    authModal.style.display = 'none';
    clearAuthErrors();
  }
});

// ========== LOGIN ==========
loginSubmitBtn.addEventListener('click', async (e) => {
  e.preventDefault();
  
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  
  // Validación básica
  if (!email || !password) {
    showAuthError('loginEmailError', 'Por favor completa todos los campos');
    return;
  }
  
  // Deshabilitar botón durante la solicitud
  loginSubmitBtn.disabled = true;
  loginSubmitBtn.innerHTML = '<div class="loader"></div>';
  
  try {
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    
    if (error) {
      showAuthError('loginEmailError', error.message);
      return;
    }
    
    // Verificar si el usuario ha confirmado su correo
    if (!data.user.email_confirmed_at) {
      showAuthError('loginEmailError', 'Debes confirmar tu correo electrónico antes de iniciar sesión');
      await supabase.auth.signOut();
      return;
    }
    
    user = data.user;
    const { data: profile, error: profileError } = await supabase.from("users").select("*").eq("id", user.id).single();
    if(!profileError) user.profile = profile;
    
    // Mostrar mensaje de éxito
    showAuthSuccess('loginSuccess', `¡Bienvenido de nuevo, ${user.email.split('@')[0]}!`);
    
    // Cerrar modal después de un breve retraso
    setTimeout(() => {
      authModal.style.display = 'none';
      updateUI();
      showNotification(`Bienvenido de nuevo, ${user.email.split('@')[0]}`, 'success');
    }, 1500);
    
  } catch (error) {
    console.error('Error during login:', error);
    showAuthError('loginEmailError', 'Error inesperado. Intenta nuevamente.');
  } finally {
    // Rehabilitar botón
    loginSubmitBtn.disabled = false;
    loginSubmitBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesión';
  }
});

// ========== REGISTRO ==========
signupSubmitBtn.addEventListener('click', async (e) => {
  e.preventDefault();
  
  const email = document.getElementById('signupEmail').value;
  const password = document.getElementById('signupPassword').value;
  const phone = document.getElementById('signupPhone').value;
  
  // Validación básica
  if (!email || !password || !phone) {
    showAuthError('signupEmailError', 'Por favor completa todos los campos');
    return;
  }
  
  if (password.length < 6) {
    showAuthError('signupPasswordError', 'La contraseña debe tener al menos 6 caracteres');
    return;
  }
  
  // Deshabilitar botón durante la solicitud
  signupSubmitBtn.disabled = true;
  signupSubmitBtn.innerHTML = '<div class="loader"></div>';
  
  try {
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: { 
        data: { phone },
        emailRedirectTo: window.location.origin
      }
    });
    
    if (error) {
      showAuthError('signupEmailError', error.message);
      return;
    }
    
    // Mostrar mensaje de éxito
    showAuthSuccess('signupSuccess', `¡Cuenta creada exitosamente! Se ha enviado un correo de verificación a ${email}.`);
    
    // Cambiar a pestaña de login después de un breve retraso
    setTimeout(() => {
      switchTab('login');
      document.getElementById('loginEmail').value = email;
      clearAuthErrors();
    }, 3000);
    
  } catch (error) {
    console.error('Error during signup:', error);
    showAuthError('signupEmailError', 'Error inesperado. Intenta nuevamente.');
  } finally {
    // Rehabilitar botón
    signupSubmitBtn.disabled = false;
    signupSubmitBtn.innerHTML = '<i class="fas fa-user-plus mr-2"></i>Registrarse';
  }
});

// Reemplazar los botones de login/signup originales
loginBtn.addEventListener('click', () => showAuthModal('login'));
signupBtn.addEventListener('click', () => showAuthModal('signup'));

// Permitir enviar formularios con Enter
document.getElementById('loginEmail').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    loginSubmitBtn.click();
  }
});

document.getElementById('loginPassword').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    loginSubmitBtn.click();
  }
});

document.getElementById('signupEmail').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    signupSubmitBtn.click();
  }
});

document.getElementById('signupPassword').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    signupSubmitBtn.click();
  }
});

document.getElementById('signupPhone').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    signupSubmitBtn.click();
  }
});

// ========== FUNCIONES EXISTENTES (se mantienen igual) ==========

// ... (El resto del código JavaScript se mantiene exactamente igual)

// -------------------- FUNCIONES DE NOTIFICACIÓN --------------------
function showNotification(message, type = 'info') {
  // Crear elemento de notificación
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  
  // Icono según el tipo
  let icon = 'fa-info-circle';
  if (type === 'success') icon = 'fa-check-circle';
  if (type === 'error') icon = 'fa-exclamation-circle';
  if (type === 'warning') icon = 'fa-exclamation-triangle';
  
  notification.innerHTML = `
    <div class="flex items-center">
      <i class="fas ${icon} mr-2"></i>
      <span>${message}</span>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  // Mostrar notificación
  setTimeout(() => {
    notification.classList.add('show');
  }, 10);
  
  // Ocultar y eliminar después de 3 segundos
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => {
      notification.remove();
    }, 300);
  }, 3000);
}

// -------------------- CATALOGO --------------------
async function loadCatalog(){
  const { data, error } = await supabase.from('scores').select('*').order('title',{ascending:true});
  if(error) return alert(error.message);
  catalog = data || [];
  renderCatalog();
}

function renderCatalog(){
  const query = searchInput.value.toLowerCase();
  catalogEl.innerHTML='';
  
  // Aplicar clase según la vista actual
  if (currentView === 'list') {
    catalogEl.classList.remove('grid', 'grid-cols-1', 'sm:grid-cols-2', 'md:grid-cols-3', 'lg:grid-cols-4');
    catalogEl.classList.add('list-view');
  } else {
    catalogEl.classList.remove('list-view');
    catalogEl.classList.add('grid', 'grid-cols-1', 'sm:grid-cols-2', 'md:grid-cols-3', 'lg:grid-cols-4');
  }
  
  if (catalog.length === 0) {
    catalogEl.innerHTML = `
      <div class="col-span-full text-center py-10">
        <i class="fas fa-music text-5xl text-purple-300 mb-4"></i>
        <p class="text-xl text-gray-600">No hay partituras disponibles en este momento</p>
      </div>
    `;
    paginationEl.classList.add('hidden');
    return;
  }
  
  // Usar la función de búsqueda mejorada
  filteredCatalog = catalog.filter(item => enhancedSearchFilter(item, query));
  
  if (filteredCatalog.length === 0) {
    catalogEl.innerHTML = `
      <div class="col-span-full text-center py-10">
        <i class="fas fa-search text-5xl text-purple-300 mb-4"></i>
        <p class="text-xl text-gray-600">No se encontraron partituras</p>
        <p class="text-gray-500">Intenta con otros términos de búsqueda</p>
      </div>
    `;
    paginationEl.classList.add('hidden');
    return;
  }
  
  // Calcular paginación
  totalCatalogPages = Math.ceil(filteredCatalog.length / itemsPerPage);
  
  // Asegurar que la página actual sea válida
  if (currentCatalogPage > totalCatalogPages) {
    currentCatalogPage = totalCatalogPages;
  }
  if (currentCatalogPage < 1) {
    currentCatalogPage = 1;
  }
  
  // Obtener elementos para la página actual
  const startIndex = (currentCatalogPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const currentItems = filteredCatalog.slice(startIndex, endIndex);
  
  // Renderizar elementos de la página actual
  currentItems.forEach(async item => {
    const card=document.createElement('div');
    card.className='card bg-white rounded-lg shadow-md p-4 flex flex-col items-center fade-in';
    
    // Convertir precio a la moneda seleccionada
    const convertedPrice = convertPrice(item.price, selectedCurrency);
    const formattedPrice = formatPrice(convertedPrice, selectedCurrency);
    
    // Cargar ratings para esta partitura
    const ratings = await loadScoreRatings(item.id);
    
    if (currentView === 'list') {
      card.innerHTML=`
        <img src="${item.cover_url||'https://via.placeholder.com/300x200?text=Partitura'}" alt="${item.title}" class="w-40 h-32 object-contain rounded mb-3">
        <div class="card-content">
          <h2 class="font-bold text-purple-800 mb-1">${item.title}</h2>
          <p class="text-sm text-gray-600 mb-1"><i class="fas fa-user mr-1"></i>${item.composer||'Desconocido'}</p>
          ${item.genre ? `<span class="genre-badge"><i class="fas fa-tag mr-1"></i>${item.genre}</span>` : ''}
          
          <!-- Mostrar rating en el catálogo -->
          <div class="rating-info mt-2">
            <div class="rating-display">
              <div class="star-rating" id="catalog-stars-${item.id}"></div>
              <span class="rating-value">${ratings.average}</span>
            </div>
            <span class="rating-count">(${ratings.count})</span>
          </div>
          
          <p class="text-lg font-bold mb-3 text-purple-700">${formattedPrice}</p>
          <div class="mt-auto">
            <audio controls src="${item.audio_url||''}" class="w-full mb-3"></audio>
            <button class="btn-primary">
              <i class="fas fa-cart-plus mr-1"></i>Añadir al Carrito
            </button>
          </div>
        </div>
      `;
    } else {
      card.innerHTML=`
        <img src="${item.cover_url||'https://via.placeholder.com/300x200?text=Partitura'}" alt="${item.title}" class="w-full h-48 object-contain rounded mb-3">
        <h2 class="font-bold text-purple-800 mb-1 text-center">${item.title}</h2>
        <p class="text-sm text-gray-600 mb-1 text-center"><i class="fas fa-user mr-1"></i>${item.composer||'Desconocido'}</p>
        ${item.genre ? `<div class="mb-2"><span class="genre-badge"><i class="fas fa-tag mr-1"></i>${item.genre}</span></div>` : ''}
        
        <!-- Mostrar rating en el catálogo -->
        <div class="rating-info mt-2">
          <div class="rating-display">
            <div class="star-rating" id="catalog-stars-${item.id}"></div>
            <span class="rating-value">${ratings.average}</span>
          </div>
          <span class="rating-count">(${ratings.count})</span>
        </div>
        
        <p class="text-lg font-bold mb-3 text-purple-700">${formattedPrice}</p>
        <div class="mt-auto w-full">
          <audio controls src="${item.audio_url||''}" class="w-full mb-3"></audio>
          <button class="btn-primary w-full">
            <i class="fas fa-cart-plus mr-1"></i>Añadir al Carrito
            </button>
        </div>
      `;
    }
    
    // Renderizar estrellas en el catálogo
    const starsContainer = card.querySelector(`#catalog-stars-${item.id}`);
    renderAverageStars(starsContainer, ratings.average);
    
    card.querySelector('button').addEventListener('click', e=>{ e.stopPropagation(); addToCart(item); });
    card.addEventListener('click', ()=>openScoreModal(item));
    
    // Añadir botón de edición para administradores
    if (user && user.profile?.is_admin) {
      const editBtn = document.createElement('button');
      editBtn.className = 'btn-secondary mt-2';
      editBtn.innerHTML = '<i class="fas fa-edit mr-1"></i>Editar';
      editBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        openEditScoreModal(item);
      });
      
      if (currentView === 'list') {
        card.querySelector('.card-content').appendChild(editBtn);
      } else {
        card.appendChild(editBtn);
      }
    }
    
    catalogEl.appendChild(card);
  });
  
  // Actualizar controles de paginación
  updatePaginationControls();
}

// ... (El resto del código JavaScript se mantiene exactamente igual)

// -------------------- MODAL DE PARTITURA --------------------
async function openScoreModal(item){
  currentScoreId = item.id;
  scorePreview.src = item.cover_url || '';
  scoreTitle.textContent = item.title;
  scoreComposer.querySelector('span').textContent = item.composer || 'Desconocido';
  
  // Actualizar precios según la moneda seleccionada
  updateScoreModalPrices(item);
  
  scoreAudio.src = item.audio_url || '';
  
  // Información adicional de la partitura
  scoreDescription.textContent = item.description || 'Descripción no disponible.';
  scoreDuration.textContent = item.duration || '--:--';
  scoreDifficulty.textContent = item.difficulty || 'Media';
  scoreInstrument.textContent = item.instrument || 'Piano';
  scorePages.textContent = item.pages || '--';
  
  // Mostrar género
  scoreGenreText.textContent = item.genre || 'No especificado';
  
  // Cargar y mostrar ratings
  const ratings = await loadScoreRatings(item.id);
  
  // Actualizar información de ratings
  document.getElementById('averageRatingValue').textContent = ratings.average;
  document.getElementById('totalVotesCount').textContent = `(${ratings.count} votos)`;
  
  // Renderizar estrellas de promedio
  const averageStarsContainer = document.getElementById('averageStars');
  renderAverageStars(averageStarsContainer, ratings.average);
  
  // Configurar votación personal del usuario
  const personalRatingSection = document.getElementById('personalRatingSection');
  const userStarRating = document.getElementById('userStarRating');
  
  if (user) {
    personalRatingSection.classList.remove('hidden');
    renderStarRating(
      userStarRating, 
      ratings.userRating || 0, 
      true, // interactivo
      async (newRating) => {
        return await submitVote(item.id, newRating);
      }
    );
    
    // Si el usuario ya votó, mostrar su rating actual
    if (ratings.userRating) {
      renderStarRating(userStarRating, ratings.userRating, true, 
        async (newRating) => {
          return await submitVote(item.id, newRating);
        }
      );
    }
  } else {
    personalRatingSection.classList.add('hidden');
  }
  
  // Mostrar vista previa del PDF si está disponible
  if (item.pdf_url) {
    renderPdfPreview(item.pdf_url);
  } else {
    pdfPreview.classList.add('hidden');
  }
  
  // Obtener duración del audio automáticamente si no está establecida
  if (!item.duration && item.audio_url) {
    getAudioDuration(item.audio_url).then(duration => {
      if (duration && duration > 0) {
        const minutes = Math.floor(duration / 60);
        const seconds = Math.floor(duration % 60);
        scoreDuration.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // Actualizar en la base de datos
        supabase.from('scores').update({ duration: `${minutes}:${seconds.toString().padStart(2, '0')}` }).eq('id', item.id);
      }
    });
  }
  
  scoreModal.style.display='flex';
  loadScoreComments(item.id);
}

// ... (El resto del código JavaScript se mantiene exactamente igual)

// -------------------- AÑADIR PARTITURA --------------------
document.getElementById('addScoreForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  if (!user || !user.profile?.is_admin) {
    showNotification('Solo los administradores pueden añadir partituras', 'error');
    return;
  }
  
  const submitBtn = document.getElementById('submitScoreBtn');
  const originalBtnText = submitBtn.innerHTML;
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<div class="loader"></div>';
  
  try {
    // Obtener el género (normal o personalizado)
    const genreSelect = document.getElementById('scoreGenreInput');
    let genre = genreSelect.value;
    
    if (genre === 'Otro') {
      const customGenre = document.getElementById('customGenreInput').value.trim();
      if (!customGenre) {
        throw new Error('Debes especificar un género personalizado');
      }
      genre = customGenre;
    }
    
    // Obtener las etiquetas
    const tags = document.getElementById('scoreTagsInput').value;
    
    // Obtener los archivos
    const coverFile = document.getElementById('scoreCoverFile').files[0];
    const pdfFile = document.getElementById('scorePdfFile').files[0];
    const audioFile = document.getElementById('scoreAudioFile').files[0];
    const midiFile = document.getElementById('scoreMidiFile').files[0];
    const mxlFile = document.getElementById('scoreMxlFile').files[0];
    
    if (!coverFile || !pdfFile) {
      throw new Error('La carátula y el PDF son obligatorios');
    }
    
    // Generar nombres únicos para los archivos
    const timestamp = Date.now();
    const coverFileName = `cover_${timestamp}_${coverFile.name}`;
    const pdfFileName = `pdf_${timestamp}_${pdfFile.name}`;
    const audioFileName = audioFile ? `audio_${timestamp}_${audioFile.name}` : null;
    const midiFileName = midiFile ? `midi_${timestamp}_${midiFile.name}` : null;
    const mxlFileName = mxlFile ? `mxl_${timestamp}_${mxlFile.name}` : null;
    
    // Subir archivos a Supabase Storage
    const uploadFile = async (file, fileName, bucket, progressBarId) => {
      if (!file) return null;
      
      if (progressBarId) {
        const progressBar = document.getElementById(progressBarId);
        const progressFill = progressBar.querySelector('.progress-bar-fill');
        progressBar.classList.remove('hidden');
        
        const { error } = await supabase.storage
          .from(bucket)
          .upload(fileName, file, {
            cacheControl: '3600',
            upsert: false,
            onUploadProgress: (progress) => {
              const percentage = (progress.loaded / progress.total) * 100;
              progressFill.style.width = `${percentage}%`;
            }
          });
          
        progressBar.classList.add('hidden');
        if (error) throw error;
      } else {
        const { error } = await supabase.storage
          .from(bucket)
          .upload(fileName, file);
        if (error) throw error;
      }
      
      // Obtener URL pública
      const { data: { publicUrl } } = supabase.storage
        .from(bucket)
        .getPublicUrl(fileName);
      
      return publicUrl;
    };
    
    // Subir todos los archivos
    const coverUrl = await uploadFile(coverFile, coverFileName, 'covers', 'coverProgressBar');
    const pdfUrl = await uploadFile(pdfFile, pdfFileName, 'pdfs', 'pdfProgressBar');
    const audioUrl = audioFile ? await uploadFile(audioFile, audioFileName, 'audios', 'audioProgressBar') : null;
    const midiUrl = midiFile ? await uploadFile(midiFile, midiFileName, 'midis', 'midiProgressBar') : null;
    const mxlUrl = mxlFile ? await uploadFile(mxlFile, mxlFileName, 'mxls', 'mxlProgressBar') : null;
    
    // Crear registro en la base de datos
    const formData = {
      title: document.getElementById('scoreTitleInput').value,
      composer: document.getElementById('scoreComposerInput').value,
      price: parseFloat(document.getElementById('scorePriceInput').value),
      genre: genre,
      tags: tags,
      description: document.getElementById('scoreDescriptionInput').value,
      difficulty: document.getElementById('scoreDifficultyInput').value,
      instrument: document.getElementById('scoreInstrumentInput').value,
      pages: document.getElementById('scorePagesInput').value ? parseInt(document.getElementById('scorePagesInput').value) : null,
      duration: document.getElementById('scoreDurationInput').value || null,
      cover_url: coverUrl,
      pdf_url: pdfUrl,
      audio_url: audioUrl,
      midi_url: midiUrl,
      mxl_url: mxlUrl
    };
    
    const { data, error } = await supabase.from('scores').insert([formData]).select();
    
    if (error) throw error;
    
    showNotification('Partitura añadida correctamente', 'success');
    document.getElementById('addScoreForm').reset();
    document.getElementById('addScoreModal').style.display = 'none';
    document.getElementById('extractedInstruments').classList.add('hidden');
    document.getElementById('extractInstrumentsBtn').classList.add('hidden');
    document.getElementById('customGenreContainer').classList.add('hidden');
    
    // Recargar el catálogo
    loadCatalog();
  } catch (error) {
    console.error('Error adding score:', error);
    showNotification('Error al añadir la partitura: ' + error.message, 'error');
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalBtnText;
  }
});

// ... (El resto del código JavaScript se mantiene exactamente igual)

// -------------------- EDITAR PARTITURA --------------------
document.getElementById('editScoreForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const scoreId = document.getElementById('editScoreId').value;
  const coverFile = document.getElementById('editScoreCoverFile').files[0];
  const pdfFile = document.getElementById('editScorePdfFile').files[0];
  const audioFile = document.getElementById('editScoreAudioFile').files[0];
  const midiFile = document.getElementById('editScoreMidiFile').files[0];
  const removeAudio = document.getElementById('editScoreAudioFile').dataset.remove === 'true';
  const removeMidi = document.getElementById('editScoreMidiFile').dataset.remove === 'true';
  
  try {
    // Obtener el género (normal o personalizado)
    const genreSelect = document.getElementById('editScoreGenre');
    let genre = genreSelect.value;
    
    if (genre === 'Otro') {
      const customGenre = document.getElementById('editCustomGenreInput').value.trim();
      if (!customGenre) {
        throw new Error('Debes especificar un género personalizado');
      }
      genre = customGenre;
    }
    
    // Obtener las etiquetas
    const tags = document.getElementById('editScoreTags').value;
    
    let coverUrl = null;
    let pdfUrl = null;
    let audioUrl = null;
    let midiUrl = null;
    
    // Subir nueva carátula si se proporcionó
    if (coverFile) {
      const timestamp = Date.now();
      const coverFileName = `cover_${timestamp}_${coverFile.name}`;
      
      const { error: uploadError } = await supabase.storage
        .from('covers')
        .upload(coverFileName, coverFile);
      
      if (uploadError) throw uploadError;
      
      const { data: { publicUrl } } = supabase.storage
        .from('covers')
        .getPublicUrl(coverFileName);
      
      coverUrl = publicUrl;
    }
    
    // Subir nuevo PDF si se proporcionó
    if (pdfFile) {
      const timestamp = Date.now();
      const pdfFileName = `pdf_${timestamp}_${pdfFile.name}`;
      
      const { error: uploadError } = await supabase.storage
        .from('pdfs')
        .upload(pdfFileName, pdfFile);
      
      if (uploadError) throw uploadError;
      
      const { data: { publicUrl } } = supabase.storage
        .from('pdfs')
        .getPublicUrl(pdfFileName);
      
      pdfUrl = publicUrl;
    }
    
    // Subir nuevo audio si se proporcionó
    if (audioFile) {
      const timestamp = Date.now();
      const audioFileName = `audio_${timestamp}_${audioFile.name}`;
      
      const { error: uploadError } = await supabase.storage
        .from('audios')
        .upload(audioFileName, audioFile);
      
      if (uploadError) throw uploadError;
      
      const { data: { publicUrl } } = supabase.storage
        .from('audios')
        .getPublicUrl(audioFileName);
      
      audioUrl = publicUrl;
    }
    
    // Subir nuevo MIDI si se proporcionó
    if (midiFile) {
      const timestamp = Date.now();
      const midiFileName = `midi_${timestamp}_${midiFile.name}`;
      
      const { error: uploadError } = await supabase.storage
        .from('midis')
        .upload(midiFileName, midiFile);
      
      if (uploadError) throw uploadError;
      
      const { data: { publicUrl } } = supabase.storage
        .from('midis')
        .getPublicUrl(midiFileName);
      
      midiUrl = publicUrl;
    }
    
    // Preparar datos para actualizar
    const updateData = {
      title: document.getElementById('editScoreTitle').value,
      composer: document.getElementById('editScoreComposer').value,
      price: parseFloat(document.getElementById('editScorePrice').value),
      genre: genre,
      tags: tags,
      description: document.getElementById('editScoreDescription').value,
      difficulty: document.getElementById('editScoreDifficulty').value,
      instrument: document.getElementById('editScoreInstrument').value,
      pages: document.getElementById('editScorePages').value ? parseInt(document.getElementById('editScorePages').value) : null,
      duration: document.getElementById('editScoreDuration').value || null,
    };
    
    // Añadir las URLs de los archivos si se subieron nuevos
    if (coverUrl) updateData.cover_url = coverUrl;
    if (pdfUrl) updateData.pdf_url = pdfUrl;
    if (audioUrl) updateData.audio_url = audioUrl;
    if (midiUrl) updateData.midi_url = midiUrl;
    
    // Manejar eliminación de archivos
    if (removeAudio) updateData.audio_url = null;
    if (removeMidi) updateData.midi_url = null;
    
    // Actualizar en la base de datos
    const { error } = await supabase.from('scores')
      .update(updateData)
      .eq('id', scoreId);
    
    if (error) throw error;
    
    showNotification('Partitura actualizada correctamente', 'success');
    document.getElementById('editScoreModal').style.display = 'none';
    
    // Recargar el catálogo
    loadCatalog();
  } catch (error) {
    console.error('Error updating score:', error);
    showNotification('Error al actualizar la partitura: ' + error.message, 'error');
  }
});

// ========== INICIALIZACIÓN ==========

// Al cargar la página, inicializar las nuevas funcionalidades
document.addEventListener('DOMContentLoaded', function() {
  setupGenreInputs();
  setupEnhancedSearch();
});

// ... (El resto del código JavaScript se mantiene exactamente igual)

// -------------------- SISTEMA DE VOTACIÓN --------------------
async function loadScoreRatings(scoreId) {
  if (!user) return { average: 0, count: 0, userRating: null };
  
  try {
    // Obtener el promedio y conteo de votos
    const { data: ratingsData, error: ratingsError } = await supabase
      .from('votes')
      .select('rating')
      .eq('score_id', scoreId);
    
    if (ratingsError) throw ratingsError;
    
    // Obtener la votación del usuario actual
    const { data: userRatingData, error: userRatingError } = await supabase
      .from('votes')
      .select('rating')
      .eq('score_id', scoreId)
      .eq('user_id', user.id)
      .single();
    
    if (userRatingError && userRatingError.code !== 'PGRST116') {
      throw userRatingError;
    }
    
    // Calcular promedio
    let average = 0;
    let count = 0;
    
    if (ratingsData && ratingsData.length > 0) {
      const sum = ratingsData.reduce((acc, item) => acc + item.rating, 0);
      average = sum / ratingsData.length;
      count = ratingsData.length;
    }
    
    return {
      average: Math.round(average * 10) / 10, // Redondear a 1 decimal
      count: count,
      userRating: userRatingData ? userRatingData.rating : null
    };
  } catch (error) {
    console.error('Error loading ratings:', error);
    return { average: 0, count: 0, userRating: null };
  }
}

async function submitVote(scoreId, rating) {
  if (!user) {
    showNotification('Debes iniciar sesión para votar', 'error');
    return;
  }
  
  try {
    // Verificar si el usuario ya votó
    const { data: existingVote, error: checkError } = await supabase
      .from('votes')
      .select('id')
      .eq('score_id', scoreId)
      .eq('user_id', user.id)
      .single();
    
    let result;
    
    if (existingVote) {
      // Actualizar voto existente
      result = await supabase
        .from('votes')
        .update({ rating: rating })
        .eq('id', existingVote.id);
    } else {
      // Crear nuevo voto
      result = await supabase
        .from('votes')
        .insert([{ 
          score_id: scoreId, 
          user_id: user.id, 
          rating: rating 
        }]);
    }
    
    if (result.error) throw result.error;
    
    showNotification(`Has votado con ${rating} estrellas`, 'success');
    return true;
  } catch (error) {
    console.error('Error submitting vote:', error);
    showNotification('Error al enviar tu voto', 'error');
    return false;
  }
}

function renderStarRating(container, rating, interactive = false, onRate = null) {
  container.innerHTML = '';
  
  for (let i = 1; i <= 5; i++) {
    const star = document.createElement('span');
    star.className = `star ${i <= rating ? 'active' : ''} ${interactive ? 'interactive' : ''}`;
    star.innerHTML = '★';
    star.dataset.rating = i;
    
    if (interactive) {
      star.addEventListener('mouseover', () => {
        if (interactive) {
          const stars = container.querySelectorAll('.star');
          stars.forEach(s => {
            s.classList.toggle('active', s.dataset.rating <= i);
          });
        }
      });
      
      star.addEventListener('mouseout', () => {
        if (interactive) {
          const stars = container.querySelectorAll('.star');
          stars.forEach(s => {
            s.classList.toggle('active', s.dataset.rating <= rating);
          });
        }
      });
      
      star.addEventListener('click', async () => {
        if (interactive && onRate) {
          const newRating = parseInt(star.dataset.rating);
          const success = await onRate(newRating);
          if (success) {
            // Animar la estrella
            star.classList.add('animated');
            setTimeout(() => {
              star.classList.remove('animated');
            }, 500);
            
            // Actualizar visualmente
            const stars = container.querySelectorAll('.star');
            stars.forEach(s => {
              s.classList.toggle('active', s.dataset.rating <= newRating);
            });
          }
        }
      });
    }
    
    container.appendChild(star);
  }
}

function renderAverageStars(container, average) {
  container.innerHTML = '';
  
  const fullStars = Math.floor(average);
  const hasHalfStar = average % 1 >= 0.5;
  
  for (let i = 1; i <= 5; i++) {
    const star = document.createElement('span');
    
    if (i <= fullStars) {
      star.className = 'star active';
      star.innerHTML = '★';
    } else if (i === fullStars + 1 && hasHalfStar) {
      star.className = 'star active';
      star.innerHTML = '★';
      star.style.opacity = '0.7';
    } else {
      star.className = 'star';
      star.innerHTML = '★';
    }
    
    container.appendChild(star);
  }
}

// -------------------- MEJORA DEL SISTEMA DE GÉNEROS --------------------
function setupGenreInputs() {
  const genreSelect = document.getElementById('scoreGenreInput');
  const customGenreContainer = document.getElementById('customGenreContainer');
  const customGenreInput = document.getElementById('customGenreInput');
  
  const editGenreSelect = document.getElementById('editScoreGenre');
  const editCustomGenreContainer = document.getElementById('editCustomGenreContainer');
  const editCustomGenreInput = document.getElementById('editCustomGenreInput');
  
  // Para el formulario de añadir
  genreSelect.addEventListener('change', function() {
    if (this.value === 'Otro') {
      customGenreContainer.classList.remove('hidden');
      customGenreContainer.classList.add('visible');
      customGenreInput.required = true;
    } else {
      customGenreContainer.classList.remove('visible');
      customGenreContainer.classList.add('hidden');
      customGenreInput.required = false;
      customGenreInput.value = '';
    }
  });
  
  // Para el formulario de editar
  editGenreSelect.addEventListener('change', function() {
    if (this.value === 'Otro') {
      editCustomGenreContainer.classList.remove('hidden');
      editCustomGenreContainer.classList.add('visible');
      editCustomGenreInput.required = true;
    } else {
      editCustomGenreContainer.classList.remove('visible');
      editCustomGenreContainer.classList.add('hidden');
      editCustomGenreInput.required = false;
      editCustomGenreInput.value = '';
    }
  });
}

// -------------------- SISTEMA DE BÚSQUEDA MEJORADO --------------------
function setupEnhancedSearch() {
  const searchInput = document.getElementById('search');
  const searchSuggestions = document.getElementById('searchSuggestions');
  
  // Generar sugerencias de búsqueda
  const searchTags = [
    '#jazz', '#clásica', '#rock', '#pop', '#folk', 
    '#banda_sonora', '#piano', '#guitarra', '#violín',
    '#fácil', '#media', '#difícil', '#avanzada'
  ];
  
  searchInput.addEventListener('input', function() {
    const query = this.value.toLowerCase();
    
    if (query.length < 2) {
      searchSuggestions.classList.remove('visible');
      return;
    }
    
    // Filtrar sugerencias
    const filteredTags = searchTags.filter(tag => 
      tag.toLowerCase().includes(query)
    );
    
    // Mostrar sugerencias
    if (filteredTags.length > 0) {
      searchSuggestions.innerHTML = '';
      
      filteredTags.forEach(tag => {
        const suggestion = document.createElement('div');
        suggestion.className = 'suggestion-item';
        suggestion.textContent = tag;
        suggestion.addEventListener('click', () => {
          searchInput.value = tag;
          searchSuggestions.classList.remove('visible');
          currentCatalogPage = 1;
          renderCatalog();
        });
        searchSuggestions.appendChild(suggestion);
      });
      
      searchSuggestions.classList.add('visible');
    } else {
      searchSuggestions.classList.remove('visible');
    }
  });
  
  // Ocultar sugerencias al hacer clic fuera
  document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !searchSuggestions.contains(e.target)) {
      searchSuggestions.classList.remove('visible');
    }
  });
}

// Función mejorada de búsqueda que incluye etiquetas
function enhancedSearchFilter(item, query) {
  if (!query) return true;
  
  const lowerQuery = query.toLowerCase();
  
  // Búsqueda normal en título, compositor, género
  if (item.title.toLowerCase().includes(lowerQuery) ||
      (item.composer && item.composer.toLowerCase().includes(lowerQuery)) ||
      (item.genre && item.genre.toLowerCase().includes(lowerQuery)) ||
      (item.instrument && item.instrument.toLowerCase().includes(lowerQuery)) ||
      (item.description && item.description.toLowerCase().includes(lowerQuery))) {
    return true;
  }
  
  // Búsqueda por hashtags/etiquetas
  if (lowerQuery.startsWith('#')) {
    const tag = lowerQuery.substring(1);
    
    // Mapeo de etiquetas a géneros/instrumentos
    const tagMappings = {
      'jazz': ['Jazz', 'Blues', 'Swing'],
      'clásica': ['Clásica', 'Clasica', 'Clásico', 'Clasico'],
      'rock': ['Rock', 'Rock & Roll'],
      'pop': ['Pop', 'Popular'],
      'folk': ['Folk', 'Folclórico', 'Folclorico'],
      'banda_sonora': ['Bandas Sonoras', 'Soundtrack', 'Banda Sonora'],
      'piano': ['Piano', 'Pianoforte'],
      'guitarra': ['Guitarra', 'Guitar'],
      'violín': ['Violín', 'Violin', 'Violinista'],
      'fácil': ['Fácil', 'Facil', 'Principiante'],
      'media': ['Media', 'Intermedio', 'Intermedia'],
      'difícil': ['Difícil', 'Dificil', 'Avanzado', 'Avanzada'],
      'avanzada': ['Avanzada', 'Avanzado', 'Experto']
    };
    
    if (tagMappings[tag]) {
      return tagMappings[tag].some(mappedTag => 
        (item.genre && item.genre.includes(mappedTag)) ||
        (item.instrument && item.instrument.includes(mappedTag)) ||
        (item.difficulty && item.difficulty.includes(mappedTag)) ||
        (item.tags && item.tags.toLowerCase().includes(tag))
      );
    }
    
    // Búsqueda directa en etiquetas si existen
    if (item.tags && item.tags.toLowerCase().includes(tag)) {
      return true;
    }
  }
  
  return false;
}

// -------------------- CONVERSIÓN DE MONEDAS --------------------
async function loadExchangeRates() {
  try {
    // Usar una API gratuita de tasas de cambio (ejemplo con Frankfurter)
    const response = await fetch('https://api.frankfurter.app/latest?from=CUP&to=USD,EUR,GBP,MXN');
    
    if (!response.ok) {
      throw new Error('No se pudieron cargar las tasas de cambio');
    }
    
    const data = await response.json();
    
    // Tasas de cambio fijas (en caso de que la API falle)
    const fallbackRates = {
      USD: 0.04,   // 1 CUP = 0.04 USD (aproximado)
      EUR: 0.037,  // 1 CUP = 0.037 EUR
      GBP: 0.032,  // 1 CUP = 0.032 GBP
      MXN: 0.67    // 1 CUP = 0.67 MXN
    };
    
    // Usar tasas de la API o las de respaldo
    exchangeRates = {
      CUP: 1,
      USD: data.rates?.USD || fallbackRates.USD,
      EUR: data.rates?.EUR || fallbackRates.EUR,
      GBP: data.rates?.GBP || fallbackRates.GBP,
      MXN: data.rates?.MXN || fallbackRates.MXN
    };
    
    console.log('Tasas de cambio cargadas:', exchangeRates);
  } catch (error) {
    console.error('Error cargando tasas de cambio:', error);
    
    // Usar tasas de cambio fijas como respaldo
    exchangeRates = {
      CUP: 1,
      USD: 0.04,
      EUR: 0.037,
      GBP: 0.032,
      MXN: 0.67
    };
    
    showNotification('Usando tasas de cambio aproximadas', 'info');
  }
}

function convertPrice(priceInCUP, currency) {
  if (currency === 'CUP') return priceInCUP;
  if (!exchangeRates[currency]) return priceInCUP;
  
  const converted = priceInCUP * exchangeRates[currency];
  return converted.toFixed(2);
}

function getCurrencySymbol(currency) {
  const symbols = {
    CUP: '$',
    USD: '$',
    EUR: '€',
    GBP: '£',
    MXN: '$'
  };
  return symbols[currency] || '$';
}

function formatPrice(price, currency) {
  const symbol = getCurrencySymbol(currency);
  return `${symbol}${price}`;
}

// Cambiar moneda seleccionada
currencySelector.addEventListener('change', (e) => {
  selectedCurrency = e.target.value;
  renderCatalog();
  renderCart();
  
  // Actualizar precios en el modal si está abierto
  if (currentScoreId) {
    const currentItem = catalog.find(item => item.id === currentScoreId);
    if (currentItem) {
      updateScoreModalPrices(currentItem);
    }
  }
});

// -------------------- PAGINACIÓN --------------------
function updatePaginationControls() {
  // Mostrar u ocultar paginación según sea necesario
  if (filteredCatalog.length <= itemsPerPage) {
    paginationEl.classList.add('hidden');
    return;
  }
  
  paginationEl.classList.remove('hidden');
  
  // Actualizar información de página
  pageInfoEl.textContent = `Página ${currentCatalogPage} de ${totalCatalogPages}`;
  
  // Habilitar/deshabilitar botones de navegación
  prevPageBtn.disabled = currentCatalogPage <= 1;
  nextPageBtn.disabled = currentCatalogPage >= totalCatalogPages;
  
  // Generar números de página
  pageNumbersEl.innerHTML = '';
  
  // Mostrar máximo 5 números de página alrededor de la página actual
  const startPage = Math.max(1, currentCatalogPage - 2);
  const endPage = Math.min(totalCatalogPages, startPage + 4);
  
  for (let i = startPage; i <= endPage; i++) {
    const pageBtn = document.createElement('button');
    pageBtn.className = `page-btn ${i === currentCatalogPage ? 'active' : ''}`;
    pageBtn.textContent = i;
    pageBtn.addEventListener('click', () => {
      currentCatalogPage = i;
      renderCatalog();
      // Desplazar hacia arriba para ver el catálogo
      window.scrollTo({ top: catalogEl.offsetTop - 140, behavior: 'smooth' });
    });
    pageNumbersEl.appendChild(pageBtn);
  }
}

// Event listeners para botones de paginación
prevPageBtn.addEventListener('click', () => {
  if (currentCatalogPage > 1) {
    currentCatalogPage--;
    renderCatalog();
    // Desplazar hacia arriba para ver el catálogo
    window.scrollTo({ top: catalogEl.offsetTop - 140, behavior: 'smooth' });
  }
});

nextPageBtn.addEventListener('click', () => {
  if (currentCatalogPage < totalCatalogPages) {
    currentCatalogPage++;
    renderCatalog();
    // Desplazar hacia arriba para ver el catálogo
    window.scrollTo({ top: catalogEl.offsetTop - 140, behavior: 'smooth' });
  }
});

// -------------------- TOGGLE DE VISTA --------------------
viewToggleBtn.addEventListener('click', () => {
  currentView = currentView === 'grid' ? 'list' : 'grid';
  viewToggleBtn.innerHTML = currentView === 'grid' ? '<i class="fas fa-list"></i>' : '<i class="fas fa-th-large"></i>';
  renderCatalog();
  
  // Guardar preferencia en localStorage
  localStorage.setItem('preferredView', currentView);
});

// Cargar preferencia de vista al iniciar
const savedView = localStorage.getItem('preferredView');
if (savedView) {
  currentView = savedView;
  viewToggleBtn.innerHTML = currentView === 'grid' ? '<i class="fas fa-list"></i>' : '<i class="fas fa-th-large"></i>';
}

// -------------------- CARRITO --------------------
function addToCart(item){
  if(!user) return showNotification('Debes iniciar sesión para añadir al carrito', 'warning');
  const existing = cart.find(c=>c.id===item.id);
  if(existing){ existing.qty+=1; } else { cart.push({...item, qty:1}); }
  renderCart();
  showNotification(`"${item.title}" añadida al carrito`, 'success');
}

function renderCart(){
  cartList.innerHTML='';
  let totalCUP = 0;
  let totalItems = 0;
  
  cart.forEach(i=>{
    totalCUP += (i.price||0)*i.qty;
    totalItems += i.qty;
    
    // Convertir precio a la moneda seleccionada
    const convertedPrice = convertPrice(i.price, selectedCurrency);
    const convertedTotal = convertPrice(i.price * i.qty, selectedCurrency);
    const formattedPrice = formatPrice(convertedPrice, selectedCurrency);
    const formattedTotal = formatPrice(convertedTotal, selectedCurrency);
    
    const li=document.createElement('li');
    li.className="flex justify-between items-center mb-3 p-2 bg-purple-50 rounded-lg";
    li.innerHTML=`
      <div class="flex-1">
        <p class="font-medium">${i.title}</p>
        <p class="text-sm text-gray-600">${formattedPrice} x ${i.qty} = ${formattedTotal}</p>
      </div>
      <div class="flex gap-2">
        <button class="bg-purple-200 text-purple-800 px-2 rounded-full"><i class="fas fa-minus"></i></button>
        <button class="bg-purple-200 text-purple-800 px-2 rounded-full"><i class="fas fa-plus"></i></button>
      </div>
    `;
    li.querySelector('button:nth-child(1)').addEventListener('click', ()=>{
      i.qty-=1;
      if(i.qty<=0) cart=cart.filter(c=>c.id!==i.id);
      renderCart();
    });
    li.querySelector('button:nth-child(2)').addEventListener('click', ()=>{
      i.qty+=1; renderCart();
    });
    cartList.appendChild(li);
  });
  
  if(cart.length>0){
    // Convertir total a la moneda seleccionada
    const convertedTotal = convertPrice(totalCUP, selectedCurrency);
    const formattedTotal = formatPrice(convertedTotal, selectedCurrency);
    
    cartTotal.classList.remove('hidden'); 
    cartTotal.textContent=`Total: ${formattedTotal}`; 
    paymentInfo.classList.remove('hidden'); 
    sendOrderBtn.classList.remove('hidden');
    clearCartBtn.classList.remove('hidden');
    cartCount.classList.remove('hidden');
    cartCount.textContent = totalItems > 9 ? '9+' : totalItems;
  } else {
    cartTotal.classList.add('hidden'); 
    paymentInfo.classList.add('hidden'); 
    sendOrderBtn.classList.add('hidden');
    clearCartBtn.classList.add('hidden');
    cartCount.classList.add('hidden');
    cartList.innerHTML = '<li class="text-center text-gray-500 py-4"><i class="fas fa-shopping-cart text-2xl mb-2"></i><p>Tu carrito está vacío</p></li>';
  }
}

// Vaciar carrito
clearCartBtn.addEventListener('click', ()=>{
  if (cart.length === 0) return;
  if (confirm('¿Estás seguro de que quieres vaciar el carrito?')) {
    cart = [];
    renderCart();
    showNotification('Carrito vaciado', 'info');
  }
});

// -------------------- PEDIDOS --------------------
sendOrderBtn.addEventListener('click', async ()=>{
  if(cart.length===0) return;
  
  // Convertir total a CUP para la confirmación
  const totalCUP = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
  const convertedTotal = convertPrice(totalCUP, selectedCurrency);
  const formattedTotal = formatPrice(convertedTotal, selectedCurrency);
  
  // Confirmar antes de enviar
  if (!confirm(`¿Confirmar pedido por un total de ${formattedTotal}?`)) {
    return;
  }
  
  for(const item of cart){ 
    for(let i=0;i<item.qty;i++){ 
      await supabase.from('purchases').insert([{ user_id: user.id, score_id: item.id, approved:false }]); 
    } 
  }
  cart=[]; 
  renderCart(); 
  showNotification('Pedido enviado. Espera aprobación del administrador.', 'success');
});

// -------------------- VER PEDIDOS USUARIO --------------------
async function loadOrders(){
  ordersList.innerHTML='';
  const { data, error } = await supabase.from('purchases').select('*, scores(*)').eq('user_id', user.id);
  if(error) return alert(error.message);
  if(!data || data.length===0){
    const msg=document.createElement('div');
    msg.className="no-orders-msg col-span-full"; 
    msg.innerHTML = `<div><i class="fas fa-inbox text-4xl mb-3"></i><p>No hay pedidos</p></div>`; 
    ordersList.appendChild(msg); 
    return;
  }
  data.forEach(p=>{
    const div=document.createElement('div');
    div.className='card bg-white rounded-lg shadow-md p-4 flex flex-col items-center fade-in';
    div.innerHTML=`
      <img src="${p.scores.cover_url||'https://via.placeholder.com/300x200?text=Partitura'}" alt="${p.scores.title}" class="w-full h-40 object-contain rounded mb-3">
      <h2 class="font-bold text-purple-800 mb-1 text-center">${p.scores.title}</h2>
      <p class="text-sm text-gray-600 mb-3 text-center"><i class="fas fa-user mr-1"></i>${p.scores.composer||'Desconocido'}</p>
      <div class="actions flex flex-col gap-2 w-full"></div>
    `;
    const actions=div.querySelector('.actions');
    if(p.approved){
      actions.innerHTML = `<p class="text-green-600 font-bold text-center mb-2"><i class="fas fa-check-circle mr-1"></i>Aprobado</p>`;
      
      // Contador de descargas realizadas
      let downloadsCompleted = 0;
      if(p.pdf_downloaded) downloadsCompleted++;
      if(p.midi_downloaded) downloadsCompleted++;
      if(p.audio_downloaded) downloadsCompleted++;
      
      if(p.scores.pdf_url){ 
        const btn=document.createElement('button'); 
        btn.className="btn-primary"; 
        btn.innerHTML=`<i class="fas fa-file-pdf mr-1"></i>Descargar PDF ${p.pdf_downloaded ? '<span class="download-badge completed">✓</span>' : '<span class="download-badge pending">!</span>'}`; 
        btn.addEventListener('click', async ()=>{ 
          if(p.pdf_downloaded){ 
            showNotification("Ya descargaste el PDF.", 'warning');
            return; 
          } 
          window.open(p.scores.pdf_url,"_blank"); 
          await supabase.from('purchases').update({pdf_downloaded:true}).eq('id',p.id); 
          p.pdf_downloaded=true;
          
          // Verificar si se completaron las 3 descargas
          if(p.pdf_downloaded && p.midi_downloaded && p.audio_downloaded) {
            // Eliminar el pedido de la base de datos y de la lista
            await supabase.from('purchases').delete().eq('id', p.id);
            setTimeout(() => {
              div.remove();
              showNotification('¡Todas las descargas completadas! El pedido se ha eliminado.', 'success');
              
              // Si no quedan pedidos, mostrar mensaje
              if(document.querySelectorAll('#ordersList > div').length === 0) {
                ordersList.innerHTML = `
                  <div class="no-orders-msg col-span-full">
                    <div><i class="fas fa-check-circle text-4xl mb-3"></i><p>No hay pedidos pendientes</p></div>
                  </div>
                `;
              }
            }, 2000);
          } else {
            // Actualizar el botón
            btn.innerHTML=`<i class="fas fa-file-pdf mr-1"></i>Descargar PDF <span class="download-badge completed">✓</span>`;
          }
        }); 
        actions.appendChild(btn); 
      }
      
      if(p.scores.midi_url){ 
        const btn=document.createElement('button'); 
        btn.className="btn-primary"; 
        btn.innerHTML=`<i class="fas fa-music mr-1"></i>Descargar MIDI ${p.midi_downloaded ? '<span class="download-badge completed">✓</span>' : '<span class="download-badge pending">!</span>'}`; 
        btn.addEventListener('click', async ()=>{ 
          if(p.midi_downloaded){ 
            showNotification("Ya descargaste el MIDI.", 'warning');
            return; 
          } 
          window.open(p.scores.midi_url,"_blank"); 
          await supabase.from('purchases').update({midi_downloaded:true}).eq('id',p.id); 
          p.midi_downloaded=true;
          
          // Verificar si se completaron las 3 descargas
          if(p.pdf_downloaded && p.midi_downloaded && p.audio_downloaded) {
            // Eliminar el pedido de la base de datos y de la lista
            await supabase.from('purchases').delete().eq('id', p.id);
            setTimeout(() => {
              div.remove();
              showNotification('¡Todas las descargas completadas! El pedido se ha eliminado.', 'success');
              
              // Si no quedan pedidos, mostrar mensaje
              if(document.querySelectorAll('#ordersList > div').length === 0) {
                ordersList.innerHTML = `
                  <div class="no-orders-msg col-span-full">
                    <div><i class="fas fa-check-circle text-4xl mb-3"></i><p>No hay pedidos pendientes</p></div>
                  </div>
                `;
              }
            }, 2000);
          } else {
            // Actualizar el botón
            btn.innerHTML=`<i class="fas fa-music mr-1"></i>Descargar MIDI <span class="download-badge completed">✓</span>`;
          }
        }); 
        actions.appendChild(btn); 
      }
      
      if(p.scores.audio_url){ 
        const btn=document.createElement('button'); 
        btn.className="btn-primary"; 
        btn.innerHTML=`<i class="fas fa-file-audio mr-1"></i>Descargar MP3 ${p.audio_downloaded ? '<span class="download-badge completed">✓</span>' : '<span class="download-badge pending">!</span>'}`; 
        btn.addEventListener('click', async ()=>{ 
          if(p.audio_downloaded){ 
            showNotification("Ya descargaste el MP3.", 'warning');
            return; 
          } 
          window.open(p.scores.audio_url,"_blank"); 
          await supabase.from('purchases').update({audio_downloaded:true}).eq('id',p.id); 
          p.audio_downloaded=true;
          
          // Verificar si se completaron las 3 descargas
          if(p.pdf_downloaded && p.midi_downloaded && p.audio_downloaded) {
            // Eliminar el pedido de la base de datos y de la lista
            await supabase.from('purchases').delete().eq('id', p.id);
            setTimeout(() => {
              div.remove();
              showNotification('¡Todas las descargas completadas! El pedido se ha eliminado.', 'success');
              
              // Si no quedan pedidos, mostrar mensaje
              if(document.querySelectorAll('#ordersList > div').length === 0) {
                ordersList.innerHTML = `
                  <div class="no-orders-msg col-span-full">
                    <div><i class="fas fa-check-circle text-4xl mb-3"></i><p>No hay pedidos pendientes</p></div>
                  </div>
                `;
              }
            }, 2000);
          } else {
            // Actualizar el botón
            btn.innerHTML=`<i class="fas fa-file-audio mr-1"></i>Descargar MP3 <span class="download-badge completed">✓</span>`;
          }
        }); 
        actions.appendChild(btn); 
      }
    } else { 
      actions.innerHTML=`<span class="text-orange-500 font-bold text-center"><i class="fas fa-clock mr-1"></i>En espera de aprobación</span>`; 
    }
    ordersList.appendChild(div);
  });
}

// -------------------- PANEL ADMIN --------------------
async function loadAdmin(){
  adminList.innerHTML='';
  
  try {
    // Primero obtener los usuarios para poder relacionarlos manualmente
    const { data: usersData, error: usersError } = await supabase.from('users').select('id, email');
    if(usersError) throw usersError;
    
    // Obtener las compras pendientes
    const { data: purchasesData, error: purchasesError } = await supabase
      .from('purchases')
      .select('*, scores(*)')
      .eq('approved', false);
    
    if(purchasesError) throw purchasesError;
    
    if(!purchasesData || purchasesData.length===0){
      const msg=document.createElement('div');
      msg.className="no-orders-msg col-span-full"; 
      msg.innerHTML = `<div><i class="fas fa-check-circle text-4xl mb-3"></i><p>No hay pedidos pendientes</p></div>`; 
      adminList.appendChild(msg); 
      return;
    }
    
    // Relacionar manualmente los usuarios con las compras
    const purchasesWithUsers = purchasesData.map(purchase => {
      const user = usersData.find(u => u.id === purchase.user_id);
      return {
        ...purchase,
        users: user ? { email: user.email } : { email: 'Usuario desconocido' }
      };
    });
    
    purchasesWithUsers.forEach(p=>{
      const div=document.createElement('div');
      div.className='card bg-white rounded-lg shadow-md p-4 flex flex-col items-center fade-in';
      div.innerHTML=`
        <img src="${p.scores.cover_url||'https://via.placeholder.com/300x200?text=Partitura'}" alt="${p.scores.title}" class="w-full h-40 object-contain rounded mb-3">
        <h2 class="font-bold text-purple-800 mb-1 text-center">${p.scores.title}</h2>
        <p class="text-sm text-gray-600 mb-3 text-center"><i class="fas fa-user mr-1"></i>${p.users.email}</p>
        <button class="btn-primary w-full">
          <i class="fas fa-check-circle mr-1"></i>Aprobar
        </button>
      `;
      div.querySelector('button').addEventListener('click', async ()=> {
        await supabase.from('purchases').update({approved:true}).eq('id', p.id);
        showNotification(`Pedido de ${p.scores.title} aprobado`, 'success');
        loadAdmin();
      });
      adminList.appendChild(div);
    });
  } catch (error) {
    console.error('Error loading admin data:', error);
    showNotification('Error al cargar los datos de administración: ' + error.message, 'error');
  }
}

// -------------------- CARGAR TABLA DE ADMINISTRACIÓN --------------------
async function loadAdminOrdersTable() {
  const adminOrdersTable = document.getElementById('adminOrdersTable');
  adminOrdersTable.innerHTML = '<tr><td colspan="4" class="text-center py-4">Cargando...</td></tr>';
  
  try {
    // Primero obtener los usuarios para poder relacionarlos manualmente
    const { data: usersData, error: usersError } = await supabase.from('users').select('id, email');
    if(usersError) throw usersError;
    
    // Obtener las compras pendientes
    const { data: purchasesData, error: purchasesError } = await supabase
      .from('purchases')
      .select('*, scores(*)')
      .eq('approved', false)
      .order('created_at', { ascending: false });
    
    if(purchasesError) throw purchasesError;
    
    if(!purchasesData || purchasesData.length===0){
      adminOrdersTable.innerHTML = '<tr><td colspan="4" class="text-center py-4">No hay pedidos pendientes de aprobación</td></tr>';
      return;
    }
    
    // Relacionar manualmente los usuarios con las compras
    const purchasesWithUsers = purchasesData.map(purchase => {
      const user = usersData.find(u => u.id === purchase.user_id);
      return {
        ...purchase,
        users: user ? { email: user.email } : { email: 'Usuario desconocido' }
      };
    });
    
    adminOrdersTable.innerHTML = '';
    
    purchasesWithUsers.forEach(p => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${p.users.email}</td>
        <td>${p.scores.title}</td>
        <td>${new Date(p.created_at).toLocaleDateString()}</td>
        <td>
          <button class="btn-primary approve-btn" data-id="${p.id}">
            <i class="fas fa-check mr-1"></i>Aprobar
          </button>
        </td>
      `;
      adminOrdersTable.appendChild(row);
    });
    
    // Agregar event listeners a los botones de aprobación
    document.querySelectorAll('.approve-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const purchaseId = e.target.closest('.approve-btn').dataset.id;
        await supabase.from('purchases').update({approved: true}).eq('id', purchaseId);
        showNotification('Pedido aprobado correctamente', 'success');
        loadAdminOrdersTable();
      });
    });
  } catch (error) {
    console.error('Error loading admin orders table:', error);
    adminOrdersTable.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">Error al cargar los pedidos</td></tr>';
  }
}

// -------------------- CARGAR TABLA DE USUARIOS (CORREGIDA) --------------------
async function loadAdminUsersTable() {
  const adminUsersTable = document.getElementById('adminUsersTable');
  adminUsersTable.innerHTML = '<tr><td colspan="4" class="text-center py-4">Cargando...</td></tr>';
  
  try {
    // Obtener usuarios - consulta corregida
    const { data: usersData, error: usersError } = await supabase
      .from('users')
      .select('*')
      .order('created_at', { ascending: false });
    
    if(usersError) {
      console.error('Error de Supabase:', usersError);
      throw usersError;
    }
    
    if(!usersData || usersData.length===0){
      adminUsersTable.innerHTML = '<tr><td colspan="4" class="text-center py-4">No hay usuarios registrados</td></tr>';
      return;
    }
    
    adminUsersTable.innerHTML = '';
    
    usersData.forEach(user => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${user.email || 'No disponible'}</td>
        <td>${user.phone || 'No proporcionado'}</td>
        <td>${new Date(user.created_at).toLocaleDateString()}</td>
        <td>${user.email_confirmed_at ? 'Sí' : 'No'}</td>
      `;
      adminUsersTable.appendChild(row);
    });
  } catch (error) {
    console.error('Error loading admin users table:', error);
    adminUsersTable.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">Error al cargar los usuarios: ' + error.message + '</td></tr>';
  }
}

// -------------------- EXTRACCIÓN DE INSTRUMENTOS DESDE ARCHIVOS MXL/XML (CORREGIDA) --------------------
document.getElementById('scoreMxlFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    document.getElementById('extractInstrumentsBtn').classList.remove('hidden');
  } else {
    document.getElementById('extractInstrumentsBtn').classList.add('hidden');
    document.getElementById('extractedInstruments').classList.add('hidden');
  }
});

document.getElementById('extractInstrumentsBtn').addEventListener('click', async function() {
  const file = document.getElementById('scoreMxlFile').files[0];
  if (!file) return;
  
  try {
    showNotification('Procesando archivo...', 'info');
    
    let xmlText = '';
    const fileName = file.name.toLowerCase();
    
    // Detectar si es MXL (ZIP) o XML plano
    if (fileName.endsWith('.mxl')) {
      // Procesar como MXL (archivo ZIP)
      const zip = new JSZip();
      const contents = await zip.loadAsync(file);
      
      // Buscar el archivo MusicXML (.xml) dentro del MXL
      let xmlFile = null;
      for (const filename in contents.files) {
        if (filename.endsWith('.xml')) {
          xmlFile = contents.files[filename];
          break;
        }
      }
      
      if (!xmlFile) {
        throw new Error('No se encontró un archivo XML dentro del MXL');
      }
      
      // Leer el contenido XML
      xmlText = await xmlFile.async('text');
    } else if (fileName.endsWith('.xml')) {
      // Procesar como XML plano (texto)
      xmlText = await readFileAsText(file);
    } else {
      throw new Error('Formato de archivo no válido. Use .mxl or .xml');
    }
    
    // Parsear el XML y extraer instrumentos
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
    
    // Extraer instrumentos
    const partElements = xmlDoc.getElementsByTagName('score-part');
    const instruments = [];
    
    for (let i = 0; i < partElements.length; i++) {
      const partNameElement = partElements[i].getElementsByTagName('part-name')[0];
      if (partNameElement) {
        instruments.push(partNameElement.textContent);
      }
    }
    
    // DEBUG: Ver qué se está extrayendo
    console.log('Instrumentos detectados:', instruments);
    console.log('Elemento del campo instrumentos:', document.getElementById('scoreInstrumentInput'));
    
    // Mostrar instrumentos extraídos
    if (instruments.length > 0) {
      const instrumentsList = document.getElementById('instrumentsList');
      instrumentsList.innerHTML = '';
      
      instruments.forEach(instrument => {
        const div = document.createElement('div');
        div.className = 'text-sm flex items-center';
        div.innerHTML = `<i class="fas fa-music text-purple-500 mr-2"></i> ${instrument}`;
        instrumentsList.appendChild(div);
      });
      
      document.getElementById('extractedInstruments').classList.remove('hidden');
      
      // Establecer el valor en el campo - DEBUG
      document.getElementById('scoreInstrumentInput').value = instruments.join(', ');
      console.log('Valor establecido:', document.getElementById('scoreInstrumentInput').value);
      
      showNotification(`${instruments.length} instrumentos detectados`, 'success');
    } else {
      showNotification('No se encontraron instrumentos en el archivo', 'warning');
    }
  } catch (error) {
    console.error('Error processing file:', error);
    showNotification('Error al procesar el archivo: ' + error.message, 'error');
  }
});

// Función auxiliar para leer archivos como texto
function readFileAsText(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result);
    reader.onerror = e => reject(new Error('No se pudo leer el archivo'));
    reader.readAsText(file);
  });
}

// Función para actualizar precios en el modal según la moneda seleccionada
function updateScoreModalPrices(item) {
  const convertedPrice = convertPrice(item.price, selectedCurrency);
  const formattedPrice = formatPrice(convertedPrice, selectedCurrency);
  scorePrice.textContent = formattedPrice;
}

// Función para renderizar la vista previa del PDF
async function renderPdfPreview(pdfUrl) {
  pdfPreview.innerHTML = '<p class="text-gray-500">Cargando vista previa...</p>';
  pdfPreview.classList.remove('hidden');
  
  try {
    // Cargar el PDF
    const loadingTask = pdfjsLib.getDocument(pdfUrl);
    const pdf = await loadingTask.promise;
    
    // Limitar a las primeras 2 páginas
    const numPages = Math.min(pdf.numPages, 2);
    pdfPreview.innerHTML = '';
    
    // Renderizar cada página
    for (let i = 1; i <= numPages; i++) {
      const page = await pdf.getPage(i);
      const viewport = page.getViewport({ scale: 0.5 });
      
      const pageDiv = document.createElement('div');
      pageDiv.className = 'pdf-page';
      pageDiv.dataset.page = i;
      
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      
      const renderContext = {
        canvasContext: context,
        viewport: viewport
      };
      
      await page.render(renderContext).promise;
      
      const pageNumber = document.createElement('div');
      pageNumber.className = 'pdf-page-number';
      pageNumber.textContent = `Página ${i}`;
      
      pageDiv.appendChild(canvas);
      pageDiv.appendChild(pageNumber);
      pdfPreview.appendChild(pageDiv);
      
      // Agregar evento para abrir el visor de PDF
      pageDiv.addEventListener('click', () => {
        openPdfViewer(pdfUrl, i);
      });
    }
  } catch (error) {
    console.error('Error rendering PDF preview:', error);
    pdfPreview.innerHTML = '<p class="text-red-500">No se pudo cargar la vista previa del PDF</p>';
  }
}

// Función para abrir el visor de PDF
async function openPdfViewer(pdfUrl, startPage = 1) {
  const pdfViewerModal = document.getElementById('pdfViewerModal');
  const pdfViewerContainer = document.getElementById('pdfViewerContainer');
  const pageInfo = document.getElementById('pageInfo');
  const prevPageBtn = document.getElementById('prevPage');
  const nextPageBtn = document.getElementById('nextPage');
  
  pdfViewerContainer.innerHTML = '<div class="text-center py-10"><div class="loader"></div><p class="mt-3">Cargando PDF...</p></div>';
  pdfViewerModal.style.display = 'flex';
  
  try {
    // Cargar el PDF
    const loadingTask = pdfjsLib.getDocument(pdfUrl);
    currentPdf = await loadingTask.promise;
    totalPages = currentPdf.numPages;
    currentPage = startPage;
    
    // Limitar a las primeras 2 páginas
    if (totalPages > 2) {
      totalPages = 2;
    }
    
    // Renderizar la página actual
    await renderPdfPage(currentPage);
    
    // Configurar eventos de navegación
    prevPageBtn.onclick = () => {
      if (currentPage > 1) {
        currentPage--;
        renderPdfPage(currentPage);
      }
    };
    
    nextPageBtn.onclick = () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderPdfPage(currentPage);
      }
    };
    
  } catch (error) {
    console.error('Error loading PDF:', error);
    pdfViewerContainer.innerHTML = '<p class="text-red-500 text-center py-10">Error al cargar el PDF</p>';
  }
}

// Función para renderizar una página específica del PDF
async function renderPdfPage(pageNum) {
  const pdfViewerContainer = document.getElementById('pdfViewerContainer');
  const pageInfo = document.getElementById('pageInfo');
  const prevPageBtn = document.getElementById('prevPage');
  const nextPageBtn = document.getElementById('nextPage');
  
  pdfViewerContainer.innerHTML = '<div class="text-center py-10"><div class="loader"></div><p class="mt-3">Cargando página...</p></div>';
  
  try {
    const page = await currentPdf.getPage(pageNum);
    const viewport = page.getViewport({ scale: 1.5 });
    
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    canvas.height = viewport.height;
    canvas.width = viewport.width;
    
    const renderContext = {
      canvasContext: context,
      viewport: viewport
    };
    
    await page.render(renderContext).promise;
    
    pdfViewerContainer.innerHTML = '';
    pdfViewerContainer.appendChild(canvas);
    
    // Actualizar información de página
    pageInfo.textContent = `Página ${pageNum} de ${totalPages}`;
    
    // Habilitar/deshabilitar botones de navegación
    prevPageBtn.disabled = pageNum <= 1;
    nextPageBtn.disabled = pageNum >= totalPages;
    
  } catch (error) {
    console.error('Error rendering PDF page:', error);
    pdfViewerContainer.innerHTML = '<p class="text-red-500 text-center py-10">Error al cargar la página</p>';
  }
}

// Cerrar el visor de PDF
document.querySelector('.closePdfViewer').addEventListener('click', () => {
  document.getElementById('pdfViewerModal').style.display = 'none';
  currentPdf = null;
});

// Función para obtener la duración de un archivo de audio
async function getAudioDuration(url) {
  return new Promise((resolve) => {
    const audio = new Audio();
    audio.addEventListener('loadedmetadata', () => {
      resolve(audio.duration);
    });
    audio.addEventListener('error', () => {
      resolve(null);
    });
    audio.src = url;
  });
}

scoreModal.querySelector('.closeScore').addEventListener('click', ()=>{ 
  scoreModal.style.display='none'; 
  scoreCommentsList.innerHTML=''; 
  scoreCommentInput.value=''; 
});

scoreSendCommentBtn.addEventListener('click', async ()=>{
  if(!user) return showNotification('Debes iniciar sesión para comentar', 'error');
  if(!scoreCommentInput.value.trim()) return;
  await supabase.from('score_comments').insert([{ score_id: currentScoreId, user_id: user.id, content: scoreCommentInput.value }]);
  scoreCommentInput.value='';
  loadScoreComments(currentScoreId);
});

// Añadir al carrito desde el modal
document.getElementById('addToCartModalBtn').addEventListener('click', () => {
  const currentItem = catalog.find(item => item.id === currentScoreId);
  if (currentItem) {
    addToCart(currentItem);
    showNotification(`"${currentItem.title}" añadida al carrito`, 'success');
  }
});

// -------------------- CARGAR COMENTARIOS DE PARTITURA --------------------
async function loadScoreComments(scoreId){
  const { data,error } = await supabase.from('score_comments').select('*, users(email)').eq('score_id', scoreId).order('created_at',{ascending:false});
  if(error) return;
  scoreCommentsList.innerHTML='';
  
  if (data.length === 0) {
    scoreCommentsList.innerHTML = '<p class="text-gray-500 text-center py-4">No hay comentarios aún. ¡Sé el primero en comentar!</p>';
    return;
  }
  
  data.forEach(c=>{
    const div=document.createElement('div');
    div.className='comment p-3 rounded-lg';
    div.innerHTML=`
      <div class="flex justify-between items-start mb-1">
        <strong class="text-purple-700">${c.users.email}</strong>
        <span class="text-xs text-gray-500">${new Date(c.created_at).toLocaleDateString()}</span>
      </div>
      <p class="text-gray-700">${c.content}</p>
    `;
    scoreCommentsList.appendChild(div);
  });
}

// -------------------- COMENTARIOS GENERALES --------------------
const generalCommentsList=document.getElementById('generalCommentsList');
const generalCommentInput=document.getElementById('generalCommentInput');
const sendGeneralCommentBtn=document.getElementById('sendGeneralCommentBtn');

sendGeneralCommentBtn.addEventListener('click', async ()=>{
  if(!user) return showNotification('Debes iniciar sesión', 'error');
  if(!generalCommentInput.value.trim()) return;
  await supabase.from('general_comments').insert([{ user_id: user.id, content: generalCommentInput.value }]);
  generalCommentInput.value='';
  loadGeneralComments();
});

async function loadGeneralComments(){
  const { data,error } = await supabase.from('general_comments').select('*, users(email)').order('created_at',{ascending:false});
  if(error) return;
  generalCommentsList.innerHTML='';
  
  if (data.length === 0) {
    generalCommentsList.innerHTML = '<p class="text-gray-500 text-center py-4">No hay comentarios aún. ¡Sé el primero en comentar!</p>';
    return;
  }
  
  data.forEach(c=>{
    const div=document.createElement('div');
    div.className='comment p-3 rounded-lg';
    div.innerHTML=`
      <div class="flex justify-between items-start mb-1">
        <strong class="text-purple-700">${c.users.email}</strong>
        <span class="text-xs text-gray-500">${new Date(c.created_at).toLocaleDateString()}</span>
      </div>
      <p class="text-gray-700">${c.content}</p>
    `;
    generalCommentsList.appendChild(div);
  });
}

// -------------------- EDICIÓN DE PARTITURAS --------------------
function openEditScoreModal(item) {
  const modal = document.getElementById('editScoreModal');
  
  // Llenar el formulario con los datos actuales
  document.getElementById('editScoreId').value = item.id;
  document.getElementById('editScoreTitle').value = item.title;
  document.getElementById('editScoreComposer').value = item.composer || '';
  document.getElementById('editScorePrice').value = item.price || 0;
  document.getElementById('editScoreGenre').value = item.genre || '';
  document.getElementById('editScoreTags').value = item.tags || '';
  document.getElementById('editScoreDescription').value = item.description || '';
  document.getElementById('editScoreDifficulty').value = item.difficulty || 'Media';
  document.getElementById('editScoreInstrument').value = item.instrument || '';
  document.getElementById('editScorePages').value = item.pages || '';
  document.getElementById('editScoreDuration').value = item.duration || '';
  
  // Mostrar carátula actual
  document.getElementById('editScoreCurrentCover').src = item.cover_url || 'https://via.placeholder.com/300x200?text=Partitura';
  
  // Configurar previsualización de audio si existe
  const audioPreview = document.getElementById('editScoreAudioPreview');
  const currentAudio = document.getElementById('editScoreCurrentAudio');
  
  if (item.audio_url) {
    audioPreview.classList.remove('hidden');
    currentAudio.src = item.audio_url;
    currentAudio.classList.remove('hidden');
  } else {
    audioPreview.classList.add('hidden');
    currentAudio.classList.add('hidden');
  }
  
  // Configurar previsualización de MIDI si existe
  const midiPreview = document.getElementById('editScoreMidiPreview');
  if (item.midi_url) {
    midiPreview.classList.remove('hidden');
  } else {
    midiPreview.classList.add('hidden');
  }
  
  // Mostrar el modal
  modal.style.display = 'flex';
}

// Cerrar modal de edición
document.querySelector('.closeEditScoreModal').addEventListener('click', () => {
  document.getElementById('editScoreModal').style.display = 'none';
});

// Eliminar audio
document.getElementById('removeAudioBtn').addEventListener('click', () => {
  if (confirm('¿Estás seguro de que quieres eliminar el archivo de audio?')) {
    document.getElementById('editScoreAudioPreview').classList.add('hidden');
    document.getElementById('editScoreCurrentAudio').classList.add('hidden');
    document.getElementById('editScoreCurrentAudio').src = '';
    // Marcamos para eliminar el audio en la base de datos
    document.getElementById('editScoreAudioFile').dataset.remove = 'true';
  }
});

// Eliminar MIDI
document.getElementById('removeMidiBtn').addEventListener('click', () => {
  if (confirm('¿Estás seguro de que quieres eliminar el archivo MIDI?')) {
    document.getElementById('editScoreMidiPreview').classList.add('hidden');
    // Marcamos para eliminar el MIDI en la base de datos
    document.getElementById('editScoreMidiFile').dataset.remove = 'true';
  }
});

// -------------------- AUTH (REEMPLAZADO POR EL NUEVO SISTEMA) --------------------
// Los botones de login/signup ahora abren el nuevo modal de autenticación

// -------------------- PERFIL --------------------
const profileModal = document.getElementById('profileModal');
const profileEmail = document.getElementById('profileEmail');
const profilePhone = document.getElementById('profilePhone');
const profileSignOutBtn = document.getElementById('profileSignOutBtn');

profileBtn.addEventListener('click', ()=>{
  if(!user) return showNotification("Debes iniciar sesión", 'error');
  profileEmail.textContent = user.email;
  profilePhone.textContent = user.profile?.phone || 'No proporcionado';
  profileModal.style.display='flex';
});

profileModal.querySelector('.closeProfile').addEventListener('click', ()=>{ profileModal.style.display='none'; });
profileSignOutBtn.addEventListener('click', async ()=>{ 
  await supabase.auth.signOut(); 
  user=null; 
  updateUI(); 
  profileModal.style.display='none';
  showNotification('Sesión cerrada correctamente', 'info');
});

// -------------------- BOTONES Y UI --------------------
ordersBtn.addEventListener('click', ()=>{ 
  catalogEl.classList.add('hidden'); 
  adminSection.classList.add('hidden'); 
  ordersSection.classList.remove('hidden'); 
  commentsSection.classList.add('hidden');
  loadOrders(); 
});

adminBtn.addEventListener('click', ()=>{ 
  catalogEl.classList.add('hidden'); 
  ordersSection.classList.add('hidden'); 
  adminSection.classList.remove('hidden'); 
  commentsSection.classList.add('hidden');
  loadAdmin(); 
});

// Abrir modal de administración
document.getElementById('adminBtn').addEventListener('click', () => {
  if (user && user.profile?.is_admin) {
    document.getElementById('adminModal').style.display = 'flex';
    loadAdminOrdersTable();
    loadAdminUsersTable();
  }
});

// Cerrar modal de administración
document.querySelector('.closeAdminModal').addEventListener('click', () => {
  document.getElementById('adminModal').style.display = 'none';
});

// Abrir modal para añadir partituras
addScoreBtn.addEventListener('click', () => {
  if (user && user.profile?.is_admin) {
    document.getElementById('addScoreModal').style.display = 'flex';
  } else {
    showNotification('Solo los administradores pueden añadir partituras', 'error');
  }
});

// Cerrar modal para añadir partituras
document.querySelector('.closeAddScoreModal').addEventListener('click', () => {
  document.getElementById('addScoreModal').style.display = 'none';
});

catalogBtn.addEventListener('click', ()=>{ 
  catalogEl.classList.remove('hidden'); 
  ordersSection.classList.add('hidden'); 
  adminSection.classList.add('hidden'); 
  commentsSection.classList.remove('hidden');
});

function updateUI(){
  if(user){
    loginBtn.classList.add('hidden'); 
    signupBtn.classList.add('hidden'); 
    profileBtn.classList.remove('hidden');
    ordersBtn.classList.remove('hidden'); 
    catalogBtn.classList.remove('hidden');
    commentsSection.classList.remove('hidden');
    
    if(user.profile?.is_admin) {
      adminBtn.classList.remove('hidden');
      addScoreBtn.classList.remove('hidden');
    } else {
      adminBtn.classList.add('hidden');
      addScoreBtn.classList.add('hidden');
    }
  } else {
    loginBtn.classList.remove('hidden'); 
    signupBtn.classList.remove('hidden'); 
    profileBtn.classList.add('hidden');
    ordersBtn.classList.add('hidden'); 
    adminBtn.classList.add('hidden'); 
    catalogBtn.classList.add('hidden');
    addScoreBtn.classList.add('hidden');
    commentsSection.classList.add('hidden');
  }
  renderCart(); 
  renderCatalog(); 
  catalogEl.classList.remove('hidden'); 
  ordersSection.classList.add('hidden'); 
  adminSection.classList.add('hidden');
}

// -------------------- SESION PERSISTENTE --------------------
supabase.auth.getSession().then(async ({data})=>{
  if(data.session){
    user=data.session.user;
    
    // Verificar si el usuario ha confirmado su correo
    if (!user.email_confirmed_at) {
      showNotification('Debes confirmar tu correo electrónico antes de acceder', 'error');
      await supabase.auth.signOut();
      user = null;
    } else {
      const { data: profile } = await supabase.from("users").select("*").eq("id", user.id).single();
      if(profile) user.profile=profile;
    }
  }
  updateUI();
});

// -------------------- BUSQUEDA --------------------
searchInput.addEventListener('input', () => {
  // Reiniciar a la primera página al buscar
  currentCatalogPage = 1;
  renderCatalog();
});

// -------------------- INIT --------------------
loadCatalog();
loadGeneralComments();
loadExchangeRates(); // Cargar tasas de cambio al iniciar

// -------------------- SUSCRIPCION EN TIEMPO REAL --------------------
supabase.channel('purchases-channel').on('postgres_changes',{event:'*',schema:'public',table:'purchases'},payload=>{
  if(user && payload.new?.user_id===user.id) loadOrders();
  if(user && user.profile?.is_admin) {
    loadAdmin();
    loadAdminOrdersTable();
  }
}).subscribe();

supabase.channel('score-comments-channel').on('postgres_changes',{event:'*',schema:'public',table:'score_comments'},payload=>{
  if(currentScoreId===payload.new?.score_id) loadScoreComments(currentScoreId);
}).subscribe();

supabase.channel('general-comments-channel').on('postgres_changes',{event:'*',schema:'public',table:'general_comments'},payload=>{
  loadGeneralComments();
}).subscribe();

</script>

<script>
// ======= Script de mejoras (header, sidebar móvil, tags, botón flotante) =======
(function(){
  function adjustMainPadding(){
    const header = document.querySelector('.header');
    const mains = document.querySelectorAll('main');
    if(header){
      const h = header.offsetHeight + 20;
      mains.forEach(m => { m.style.paddingTop = h + 'px'; });
      // ajustar max-heights de modales para que no desborden en móviles
      const modals = document.querySelectorAll('#scoreContentModal, #addScoreModalContent, #editScoreModalContent, #adminModalContent, #pdfViewerContent, #profileContent');
      modals.forEach(el=>{
        if(el && el.style) el.style.maxHeight = 'calc(100vh - ' + (header.offsetHeight + 40) + 'px)';
      });
    }
  }

  // Ejecutar al cargar y al redimensionar
  window.addEventListener('load', adjustMainPadding);
  window.addEventListener('resize', function(){ setTimeout(adjustMainPadding, 80); });

  // Sidebar móvil (abrir / cerrar)
  const hamburger = document.getElementById('hamburgerBtn');
  const overlay = document.getElementById('sidebarOverlay');
  const sidebar = document.getElementById('mobileSidebar');
  const closeSidebarBtns = [];
  function openSidebar(){
    if(sidebar){ sidebar.classList.add('open'); sidebar.setAttribute('aria-hidden','false'); }
    if(overlay){ overlay.classList.add('show'); }
  }
  function closeSidebar(){
    if(sidebar){ sidebar.classList.remove('open'); sidebar.setAttribute('aria-hidden','true'); }
    if(overlay){ overlay.classList.remove('show'); }
  }
  if(hamburger){ hamburger.addEventListener('click', (e)=>{ e.stopPropagation(); openSidebar(); }); }
  if(overlay){ overlay.addEventListener('click', closeSidebar); }
  document.addEventListener('click', function(e){ if(!sidebar.contains(e.target) && !hamburger.contains(e.target)){ /*closeSidebar();*/ } });

  // close buttons inside sidebar
  document.querySelectorAll('#mobileSidebar .close-sidebar').forEach(b=> b.addEventListener('click', closeSidebar));

  // Mover (clonar) botones importantes al sidebar para móviles (se hace cada vez que cambia el tamaño)
  function populateMobileMenu(){
    const menu = document.getElementById('mobileMenuButtons');
    if(!menu) return;
    menu.innerHTML = '';
    const ids = ['loginBtn','signupBtn','ordersBtn','adminBtn','catalogBtn','profileBtn','addScoreBtn'];
    ids.forEach(id => {
      const orig = document.getElementById(id);
      if(orig){
        const clone = orig.cloneNode(true);
        // remover clases que oculten en móvil y estilizar
        clone.classList.remove('hidden');
        clone.classList.remove('btn-secondary');
        clone.style.display = 'block';
        clone.style.width = '100%';
        clone.addEventListener('click', function(e){
          // trigger original click to preserve behavior if possible
          try { orig.click(); } catch(err){}
          closeSidebar();
        });
        menu.appendChild(clone);
      }
    });
    // If user info available, show it in mobileUserArea
    const userArea = document.getElementById('mobileUserArea');
    if(userArea){
      const profileEmail = document.getElementById('profileEmail');
      if(profileEmail && profileEmail.textContent.trim() !== ''){
        userArea.textContent = profileEmail.textContent;
      } else {
        userArea.textContent = '';
      }
    }
  }
  window.addEventListener('resize', populateMobileMenu);
  window.addEventListener('load', populateMobileMenu);

  // Floating Add Score button (clonado del addScoreBtn) - se mostrará solo si el botón en header no está oculto
  (function createFloatingAdd(){
    if(document.getElementById('floatingAddBtn')) return;
    const btn = document.createElement('div');
    btn.id = 'floatingAddBtn';
    btn.title = 'Añadir Partitura (solo administradores)';
    btn.innerHTML = '<i class="fas fa-plus"></i>';
    document.body.appendChild(btn);
    btn.addEventListener('click', ()=>{
      const original = document.getElementById('addScoreBtn');
      if(original) original.click();
    });
    // observar cada 400ms si el addScoreBtn está visible y mostrar/ocultar el flotante
    setInterval(()=>{
      const original = document.getElementById('addScoreBtn');
      if(original && !original.classList.contains('hidden')){
        btn.classList.add('show');
      } else {
        btn.classList.remove('show');
      }
    }, 500);
  })();

  // ===== Sistema de etiquetas (tags) más amigable para añadir/editar partituras =====
  function setupTagInput(inputId, containerId){
    const input = document.getElementById(inputId);
    if(!input) return;
    // Crear contenedor para chips si no existe
    let container = document.getElementById(containerId);
    if(!container){
      container = document.createElement('div');
      container.id = containerId;
      container.className = 'search-tags';
      input.parentNode.insertBefore(container, input.nextSibling);
    }
    let tags = [];

    // Añadir función para actualizar inputs ocultos
    function updateHiddenInputs(){
      let form = input.form || document.querySelector('form');
      if(!form) return;
      // JSON
      let jsonInput = form.querySelector('#' + inputId + 'Json');
      if(!jsonInput){ jsonInput = document.createElement('input'); jsonInput.type='hidden'; jsonInput.id = inputId + 'Json'; jsonInput.name = inputId + 'Json'; form.appendChild(jsonInput); }
      // Comma-separated
      let commaInput = form.querySelector('#' + inputId + 'Comma');
      if(!commaInput){ commaInput = document.createElement('input'); commaInput.type='hidden'; commaInput.id = inputId + 'Comma'; commaInput.name = inputId + 'Comma'; form.appendChild(commaInput); }
      // Postgres array literal
      let pgInput = form.querySelector('#' + inputId + 'PgArray');
      if(!pgInput){ pgInput = document.createElement('input'); pgInput.type='hidden'; pgInput.id = inputId + 'PgArray'; pgInput.name = inputId + 'PgArray'; form.appendChild(pgInput); }

      jsonInput.value = JSON.stringify(tags);
      commaInput.value = tags.join(',');
      pgInput.value = tags.length ? '{"' + tags.map(t=>t.replace(/"/g,'\\"')).join('","') + '"}' : '{}';

      // Mantener también el valor visible (por compatibilidad)
      input.value = tags.join(',');
    }

    function renderChips(){
      container.innerHTML = '';
      tags.forEach(t => {
        const chip = document.createElement('span');
        chip.className = 'search-tag tag-chip';
        chip.textContent = t;
        const rem = document.createElement('span');
        rem.className = 'remove-tag';
        rem.innerHTML = '&times;';
        rem.title = 'Eliminar';
        rem.addEventListener('click', function(e){
          tags = tags.filter(x => x !== t);
          renderChips();
          updateHiddenInputs();
        });
        chip.appendChild(rem);
        container.appendChild(chip);
      });
    }

    function addTag(t){
      if(!t) return;
      t = t.trim();
      if(!t) return;
      if(tags.includes(t)) return;
      tags.push(t);
      renderChips();
      updateHiddenInputs();
    }

    // Manejar Enter y coma en el campo visible
    input.addEventListener('keydown', function(e){
      if(e.key === 'Enter'){
        e.preventDefault();
        const raw = input.value.trim();
        if(raw){
          raw.split(',').map(s=>s.trim()).filter(Boolean).forEach(s=> addTag(s));
          input.value = '';
        }
      } else if(e.key === ','){
        e.preventDefault();
        const raw = input.value.trim();
        if(raw){
          raw.split(',').map(s=>s.trim()).filter(Boolean).forEach(s=> addTag(s));
          input.value = '';
        }
      }
    });

    // Si el campo tenía valor inicial, inicializar chips
    if(input.value && input.value.trim()){
      input.value.split(',').map(s=>s.trim()).filter(Boolean).forEach(s=> addTag(s));
      input.value = '';
    }

    // Asegurar que antes de submit, los campos ocultos estén actualizados
    const parentForm = input.form;
    if(parentForm){
      parentForm.addEventListener('submit', function(){ updateHiddenInputs(); });
    }
  }

  // Inicializar para formularios de añadir y editar
  document.addEventListener('DOMContentLoaded', function(){
    setupTagInput('scoreTagsInput','scoreTagsContainer');
    setupTagInput('editScoreTags','editScoreTagsContainer');
  });

  // Pequeño ajuste UX para modales: cerrar si se presiona Esc
  document.addEventListener('keydown', function(e){
    if(e.key === 'Escape'){
      document.querySelectorAll('#authModal, #profileModal, #scoreModal, #adminModal, #addScoreModal, #editScoreModal, #pdfViewerModal').forEach(m=>{
        if(m && m.style && m.style.display === 'flex') m.style.display = 'none';
      });
      closeSidebar();
    }
  });
})();
</script>
</body>
</html>
